<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cross_validate_rbf</title>
  <meta name="keywords" content="cross_validate_rbf">
  <meta name="description" content="% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas RBF/GFRB">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html GRENAT --><!-- # routines --><!-- menu.html meta -->
<h1>cross_validate_rbf
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas RBF/GFRB</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [cv]=cross_validate_rbf(data_block,data,meta,type) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas RBF/GFRB
L. LAURENT -- 14/12/2011 -- laurent@lmt.ens-cachan.fr
nouvelle  version du 31/05/2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>	% Trace QQ plot (pour cross validation)</li><li><a href="../../../GRENAT/routines/aff/scvr_plot.html" class="code" title="function scvr_plot(Zap,scvr,opt)">scvr_plot</a>	% Trace SCVR plot (pour cross validation)</li><li><a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>	% Procedure de calcul des erreurs par LOO</li><li><a href="../../../GRENAT/routines/divers/examen_in_data.html" class="code" title="function [ret]=examen_in_data(tirages,eval,grad)">examen_in_data</a>	% fonction assurant l'examen des donn�es entrante (en cas de donn�es manquantes)</li><li><a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>	% fonction assurant la normalisation/denormalisation des donnees</li><li><a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>	% fonction assurant la normalisation/denormalisation des donnees de type gradients</li><li><a href="eval_rbf.html" class="code" title="function [Z,GZ,variance,details]=eval_rbf(U,data,tir_part)">eval_rbf</a>	%fonction permettant d'evaluer le metamodele RBF en un ensemble de pts donnes</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="bloc_rbf.html" class="code" title="function [crit_min,ret]=bloc_rbf(data,meta,para,type)">bloc_rbf</a>	% Procedure de construction de la matrice RBF et de calcul de la validation croisee</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas RBF/GFRB</span>
0002 <span class="comment">%L. LAURENT -- 14/12/2011 -- laurent@lmt.ens-cachan.fr</span>
0003 <span class="comment">%nouvelle  version du 31/05/2012</span>
0004 
0005 <a name="_sub0" href="#_subfunctions" class="code">function [cv]=cross_validate_rbf(data_block,data,meta,type)</a>
0006 
0007 <span class="comment">%%DEBUG: procedure donnees manquantes a ecrire</span>
0008 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0009 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0010 <span class="comment">%%%%%%%%%% OPTIONS</span>
0011 <span class="comment">%norme employee dans le calcul de l'erreur LOO</span>
0012 <span class="comment">%MSE: norme-L2</span>
0013 LOO_norm=<span class="string">'L2'</span>;
0014 <span class="comment">%debug</span>
0015 debug=false;
0016 
0017 <span class="comment">% affichages warning ou non</span>
0018 aff_warning=false;
0019 
0020 <span class="comment">%denormalisation des grandeurs pour calcul CV</span>
0021 denorm_cv=true;
0022 
0023 <span class="comment">%parallelisme</span>
0024 numw=0;
0025 <span class="keyword">if</span> ~isempty(whos(<span class="string">'parallel'</span>,<span class="string">'global'</span>))
0026     <span class="keyword">global</span> parallel
0027     numw=parallel.num;
0028 <span class="keyword">end</span>
0029 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0030 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0031 <span class="keyword">if</span> denorm_cv;denorm_cv=data.norm.on;<span class="keyword">end</span>
0032 
0033 <span class="comment">%differents cas de figure</span>
0034 mod_debug=debug;mod_etud=meta.cv_full;mod_final=false;
0035 <span class="keyword">if</span> nargin==4
0036     <span class="keyword">switch</span> type
0037         <span class="keyword">case</span> <span class="string">'debug'</span> <span class="comment">%mode debug (grandeurs affichees)</span>
0038             fprintf(<span class="string">'+++ CV RBF en mode DEBUG\n'</span>);
0039             mod_debug=true;
0040         <span class="keyword">case</span> <span class="string">'etud'</span>  <span class="comment">%mode etude (calcul des criteres par les deux methodes</span>
0041             mod_etud=true;
0042         <span class="keyword">case</span> <span class="string">'estim'</span>  <span class="comment">%mode estimation</span>
0043             mod_etud=false;
0044             <span class="comment">% case 'nominal'  %mode nominal (calcul des criteres par la methode de Rippa)</span>
0045         <span class="keyword">case</span> <span class="string">'final'</span>    <span class="comment">%mode final (calcul des variances)</span>
0046             mod_final=true;
0047     <span class="keyword">end</span>
0048 <span class="keyword">else</span>
0049     mod_final=true;
0050 <span class="keyword">end</span>
0051 
0052 <span class="keyword">if</span> mod_debug||mod_etud
0053     condKK=condest(data_block.build.KK);
0054     <span class="keyword">if</span> condKK&gt;1e12
0055         fprintf(<span class="string">'+++ //!\\ Mauvais conditionnement (%4.2e)\n'</span>,condKK);
0056     <span class="keyword">end</span>
0057 <span class="keyword">end</span>
0058 
0059 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0060 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0061 <span class="comment">%chargement des grandeurs</span>
0062 nb_var=data.in.nb_var;
0063 nb_val=data.in.nb_val;
0064 norm_on=data.norm.on;
0065 pres_grad=data.in.pres_grad;
0066 moy_eval=data.norm.moy_eval;
0067 std_eval=data.norm.std_eval;
0068 std_tirages=data.norm.std_tirages;
0069 
0070 <span class="keyword">if</span> mod_final;tic;<span class="keyword">end</span>
0071 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0072 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0073 <span class="comment">%%% Methode de Rippa (Rippa 1999/Fasshauer 2007/Bompard 2011)</span>
0074 <span class="comment">% retrait reponse puis gradients un par un</span>
0075 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0076 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0077 <span class="comment">%vecteurs des ecarts aux echantillons retires (reponses et gradients)</span>
0078 esn=data_block.build.w./diag(data_block.build.iKK);
0079 
0080 <span class="comment">%denormalisation des grandeurs</span>
0081 infos.moy=moy_eval;
0082 infos.std=std_eval;infos.std_e=infos.std;
0083 infos.std_t=std_tirages;
0084 <span class="keyword">if</span> pres_grad
0085     <span class="keyword">if</span> norm_on&amp;&amp;denorm_cv
0086         <span class="comment">%denormalisation difference reponses</span>
0087         esr=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(esn(1:nb_val),<span class="string">'denorm_diff'</span>,infos);
0088         <span class="comment">%denormalisation difference gradients</span>
0089         esg=<a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>(esn(nb_val+1:end),<span class="string">'denorm_concat'</span>,infos);
0090         es=[esr;esg];
0091     <span class="keyword">else</span>
0092         esr=esn(1:nb_val);
0093         esg=esn(nb_val+1:end);
0094         es=esn;
0095     <span class="keyword">end</span>
0096 <span class="keyword">else</span>
0097     <span class="keyword">if</span> norm_on&amp;&amp;denorm_cv
0098         es=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(esn,<span class="string">'denorm_diff'</span>,infos);
0099     <span class="keyword">else</span>
0100         es=esn;
0101     <span class="keyword">end</span>
0102     esr=es;
0103 <span class="keyword">end</span>
0104 
0105 <span class="comment">%calcul des erreurs en reponses et en gradients (differentes normes</span>
0106 <span class="comment">%employees)</span>
0107 <span class="keyword">switch</span> LOO_norm
0108     <span class="keyword">case</span> <span class="string">'L1'</span>
0109         <span class="keyword">if</span> pres_grad
0110             cv.then.press=esr'*esr;
0111             cv.then.eloor=1/nb_val*sum(abs(esr));
0112             cv.then.eloog=1/(nb_val*nb_var)*sum(abs(esg));
0113             cv.then.eloot=1/(nb_val*(nb_var+1))*sum(abs(es));
0114             cv.press=cv.then.press;
0115             cv.eloor=cv.then.eloor;
0116             cv.eloog=cv.then.eloog;
0117             cv.eloot=cv.then.eloot;
0118         <span class="keyword">else</span>
0119             cv.then.press=es'*es;
0120             cv.then.eloot=1/nb_val*sum(abs(es));
0121             cv.press=cv.then.press;
0122             cv.eloot=cv.then.eloot;
0123         <span class="keyword">end</span>
0124     <span class="keyword">case</span> <span class="string">'L2'</span> <span class="comment">%MSE</span>
0125         <span class="keyword">if</span> pres_grad
0126             cv.then.press=esr'*esr;
0127             cv.then.eloor=1/nb_val*(cv.then.press);
0128             cv.then.eloog=1/(nb_val*nb_var)*(esg'*esg);
0129             cv.then.eloot=1/(nb_val*(nb_var+1))*(es'*es);
0130             cv.press=cv.then.press;
0131             cv.eloor=cv.then.eloor;
0132             cv.eloog=cv.then.eloog;
0133             cv.eloot=cv.then.eloot;
0134         <span class="keyword">else</span>
0135             cv.then.press=es'*es;
0136             cv.then.eloot=1/nb_val*(cv.then.press);
0137             cv.press=cv.then.press;
0138             cv.eloot=cv.then.eloot;
0139         <span class="keyword">end</span>
0140     <span class="keyword">case</span> <span class="string">'Linf'</span>
0141         <span class="keyword">if</span> pres_grad
0142             cv.then.press=esr'*esr;
0143             cv.then.eloor=1/nb_val*max(esr(:));
0144             cv.then.eloog=1/(nb_val*nb_var)*max(esg(:));
0145             cv.then.eloot=1/(nb_val*(nb_var+1))*max(es(:));
0146             cv.press=cv.then.press;
0147             cv.eloor=cv.then.eloor;
0148             cv.eloog=cv.then.eloog;
0149             cv.eloot=cv.then.eloot;
0150         <span class="keyword">else</span>
0151             cv.then.press=es'*es;
0152             cv.then.eloot=1/nb_val*max(es(:));
0153             cv.press=cv.then.press;
0154             cv.eloot=cv.then.eloot;
0155         <span class="keyword">end</span>
0156 <span class="keyword">end</span>
0157 <span class="comment">%biais moyen</span>
0158 cv.bm=1/nb_val*sum(esr);
0159 <span class="comment">%affichage qques infos</span>
0160 <span class="keyword">if</span> mod_debug||mod_final
0161     fprintf(<span class="string">'=== CV-LOO par methode de Rippa 1999 (extension Bompard 2011)\n'</span>);
0162     fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0163     <span class="keyword">if</span> pres_grad
0164         fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0165         fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0166     <span class="keyword">end</span>
0167     fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0168     fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0169 <span class="keyword">end</span>
0170 <span class="keyword">if</span> mod_final;toc;<span class="keyword">end</span>
0171 
0172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0173 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0174 <span class="comment">%%% Methode CV classique (retrait SUCCESSIVE des reponses et des gradients)</span>
0175 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0176 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0177 <span class="keyword">if</span> mod_debug
0178     tic
0179     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0180     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0181     <span class="comment">%stockage des evaluations du metamodele au point enleve</span>
0182     cv_z=zeros(nb_val,1);
0183     cv_var=zeros(nb_val,1);
0184     cv_gz=zeros(nb_val,nb_var);
0185     yy=data.build.y;
0186     KK=data_block.build.KK;
0187     fct=data_block.build.fct;
0188     para=data_block.build.para;
0189     tirages=data.in.tirages;
0190     tiragesn=data.in.tiragesn;
0191     grad=data.in.grad;
0192     eval=data.in.eval;
0193     <span class="comment">%parcours des echantillons</span>
0194     parfor (tir=1:nb_val,numw)
0195         <span class="comment">%retrait reponse</span>
0196         <span class="comment">%chargement des donnees</span>
0197         donnees_cv=data;
0198         
0199         <span class="comment">%retrait des grandeurs</span>
0200         cv_y=yy;
0201         cv_KK=KK;
0202         cv_y(tir,:)=[];
0203         cv_KK(:,tir)=[];
0204         cv_KK(tir,:)=[];
0205         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0206         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0207         <span class="comment">%calcul des coefficients</span>
0208         <span class="keyword">if</span> ~aff_warning; warning off all;<span class="keyword">end</span>
0209         cv_w=cv_KK\cv_y;
0210         <span class="keyword">if</span> ~aff_warning; warning on all;<span class="keyword">end</span>
0211         cv_tirages=tirages;
0212         cv_tiragesn=tiragesn;
0213         <span class="comment">%on retire la reponse associe</span>
0214         donnees_cv.manq.grad.on=false;
0215         donnees_cv.manq.eval.on=true;
0216         donnees_cv.manq.eval.ix_manq=tir;
0217         
0218         <span class="comment">%retrait</span>
0219         donnees_cv.build.fct=fct;
0220         donnees_cv.build.para=para;
0221         donnees_cv.build.w=cv_w;
0222         donnees_cv.build.KK=cv_KK;
0223         donnees_cv.in.nb_val=nb_val;
0224         donnees_cv.in.tirages=cv_tirages;
0225         donnees_cv.in.tiragesn=cv_tiragesn;
0226         donnees_cv.enrich.on=false;
0227         <span class="comment">%evaluation de la reponse, des derivees et de la variance au site</span>
0228         <span class="comment">%retire</span>
0229         [Z,~,variance]=<a href="eval_rbf.html" class="code" title="function [Z,GZ,variance,details]=eval_rbf(U,data,tir_part)">eval_rbf</a>(tirages(tir,:),donnees_cv);
0230         cv_z(tir)=Z;
0231         cv_var(tir)=variance;
0232         
0233         <span class="comment">%retrait gradients</span>
0234         <span class="keyword">if</span> pres_grad
0235             <span class="keyword">for</span> pos_gr=1:nb_var
0236                 <span class="comment">%chargement des donnees</span>
0237                 donnees_cv=data;
0238                 
0239                 <span class="comment">%retrait des grandeurs</span>
0240                 cv_y=yy;
0241                 cv_KK=KK;
0242                 pos=nb_val+(tir-1)*nb_var+pos_gr;
0243                 cv_y(pos,:)=[];
0244                 cv_KK(:,pos)=[];
0245                 cv_KK(pos,:)=[];
0246                 
0247                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0248                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0249                 <span class="comment">%calcul des coefficients</span>
0250                 <span class="keyword">if</span> ~aff_warning; warning off all;<span class="keyword">end</span>
0251                 cv_w=cv_KK\cv_y;
0252                 <span class="keyword">if</span> ~aff_warning; warning on all;<span class="keyword">end</span>
0253                 cv_tirages=tirages;
0254                 cv_tiragesn=tiragesn;
0255                 <span class="comment">%on retire le gradient associe</span>
0256                 donnees_cv.manq.grad.on=true;
0257                 donnees_cv.manq.eval.on=false;
0258                 donnees_cv.manq.grad.ixt_manq_line=pos-nb_val;
0259                 
0260                 <span class="comment">%retrait</span>
0261                 donnees_cv.build.fct=fct;
0262                 donnees_cv.build.para=para;
0263                 donnees_cv.build.w=cv_w;
0264                 donnees_cv.build.KK=cv_KK;
0265                 donnees_cv.in.nb_val=nb_val;
0266                 donnees_cv.in.tirages=cv_tirages;
0267                 donnees_cv.in.tiragesn=cv_tiragesn;
0268                 donnees_cv.enrich.on=false;
0269                 <span class="comment">%evaluation de la reponse, des derivees et de la variance au site</span>
0270                 <span class="comment">%retire</span>
0271                 [~,GZ,~]=<a href="eval_rbf.html" class="code" title="function [Z,GZ,variance,details]=eval_rbf(U,data,tir_part)">eval_rbf</a>(tirages(tir,:),donnees_cv);
0272                 cv_gz(tir,pos_gr)=GZ(pos_gr);
0273             <span class="keyword">end</span>
0274         <span class="keyword">end</span>
0275     <span class="keyword">end</span>
0276     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0277     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0278     <span class="comment">%% Calcul des erreurs</span>
0279     [cv.then]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_z,cv_var,grad,cv_gz,nb_val,nb_var,LOO_norm);
0280     <span class="comment">%affichage qques infos</span>
0281     <span class="keyword">if</span> mod_debug||mod_final
0282         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses PUIS gradients (debug)\n'</span>);
0283         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0284         <span class="keyword">if</span> pres_grad
0285             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0286             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0287         <span class="keyword">end</span>
0288         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0289         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.then.bm);
0290         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0291         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.then.errp);
0292         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0293         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0294         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0295         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0296     <span class="keyword">end</span>
0297     toc
0298 <span class="keyword">end</span>
0299 
0300 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0301 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0302 <span class="comment">%%% Methode CV classique (retrait simultanee des reponses et gradient en</span>
0303 <span class="comment">%%% chaque echantillon)</span>
0304 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0305 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0306 <span class="keyword">if</span> mod_etud||mod_debug||meta.cv_aff
0307     tic
0308     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0309     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0310     <span class="comment">%stockage des evaluations du metamodele au point enleve</span>
0311     cv_z=zeros(nb_val,1);
0312     cv_var=zeros(nb_val,1);
0313     cv_gz=zeros(nb_val,nb_var);
0314     yy=data.build.y;
0315     KK=data_block.build.KK;
0316     fct=data_block.build.fct;
0317     para=data_block.build.para;
0318     tirages=data.in.tirages;
0319     tiragesn=data.in.tiragesn;
0320     grad=data.in.grad;
0321     eval=data.in.eval;
0322     <span class="comment">%parcours des echantillons</span>
0323     parfor (tir=1:nb_val,numw)
0324         <span class="comment">%chargement des donnees</span>
0325         donnees_cv=data;
0326         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0327         
0328         <span class="keyword">if</span> pres_grad
0329             pos=[tir nb_val+(tir-1)*nb_var+(1:nb_var)];
0330         <span class="keyword">else</span>
0331             pos=tir;
0332         <span class="keyword">end</span>
0333         
0334         <span class="comment">%retrait des grandeurs</span>
0335         cv_y=yy;
0336         cv_KK=KK;
0337         cv_y(pos,:)=[];
0338         cv_KK(:,pos)=[];
0339         cv_KK(pos,:)=[];
0340         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0341         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0342         <span class="comment">%calcul des coefficients</span>
0343         <span class="keyword">if</span> ~aff_warning; warning off all;<span class="keyword">end</span>
0344         cv_w=cv_KK\cv_y;
0345         <span class="keyword">if</span> ~aff_warning; warning on all;<span class="keyword">end</span>
0346         cv_tirages=tirages;
0347         cv_tirages(tir,:)=[];
0348         cv_tiragesn=tiragesn;
0349         cv_tiragesn(tir,:)=[];
0350         cv_eval=eval;
0351         <span class="keyword">if</span> data.manq.eval.on||data.manq.grad.on
0352             cv_eval(tir)=[];
0353             <span class="keyword">if</span> pres_grad
0354                 cv_grad=grad;
0355                 cv_grad(tir,:)=[];
0356             <span class="keyword">else</span>
0357                 cv_grad=[];
0358             <span class="keyword">end</span>
0359             ret_manq=<a href="../../../GRENAT/routines/divers/examen_in_data.html" class="code" title="function [ret]=examen_in_data(tirages,eval,grad)">examen_in_data</a>(cv_tirages,cv_eval,cv_grad);
0360             donnees_cv.manq=ret_manq;
0361         <span class="keyword">end</span>
0362         
0363         donnees_cv.build.fct=fct;
0364         donnees_cv.build.para=para;
0365         donnees_cv.build.w=cv_w;
0366         donnees_cv.build.KK=cv_KK;
0367         donnees_cv.in.nb_val=nb_val-1; <span class="comment">%retrait d'un site</span>
0368         donnees_cv.in.tirages=cv_tirages;
0369         donnees_cv.in.tiragesn=cv_tiragesn;
0370         donnees_cv.enrich.on=false;
0371         <span class="comment">%evaluation de la reponse, des derivees et de la variance au site</span>
0372         <span class="comment">%retire</span>
0373         [Z,GZ,variance]=<a href="eval_rbf.html" class="code" title="function [Z,GZ,variance,details]=eval_rbf(U,data,tir_part)">eval_rbf</a>(tirages(tir,:),donnees_cv);
0374         cv_z(tir)=Z;
0375         cv_gz(tir,:)=GZ;
0376         cv_var(tir)=variance;
0377     <span class="keyword">end</span>
0378     
0379     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0380     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0381     <span class="comment">%% Calcul des erreurs</span>
0382     [cv.and]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_z,cv_var,grad,cv_gz,nb_val,nb_var,LOO_norm);
0383     <span class="comment">%affichage qques infos</span>
0384     <span class="keyword">if</span> mod_debug||mod_final
0385         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses ET gradients\n'</span>);
0386         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0387         <span class="keyword">if</span> pres_grad
0388             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.and.eloor);
0389             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.and.eloog);
0390         <span class="keyword">end</span>
0391         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.and.eloot);
0392         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.and.bm);
0393         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.and.press);
0394         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.and.errp);
0395         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.and.scvr_min);
0396         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.and.scvr_max);
0397         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.and.scvr_mean);
0398         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.and.adequ);
0399     <span class="keyword">end</span>
0400     toc
0401 <span class="keyword">end</span>
0402 
0403 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0404 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0405 <span class="comment">%%Calcul de la variance  de prediction aux points echantillonnes + test calcul reponses et gradients (pour CV)</span>
0406 <span class="comment">%%%ATTENTION defaut pour cas avec gradients et/ou donnees manquantes</span>
0407 <span class="keyword">if</span> meta.cv_aff||mod_debug
0408     tic
0409     cv_varR=zeros(nb_val,1);
0410     cv_zRn=zeros(nb_val,1);
0411     cv_GZn=zeros(nb_val,nb_var);
0412     KK=data_block.build.KK;
0413     yy=data.build.y;
0414     grad=data.in.grad;
0415     eval=data.in.eval;
0416     <span class="keyword">for</span> tir=1:nb_val
0417         <span class="comment">%retrait des reponses seules</span>
0418         pos=tir;
0419         <span class="comment">%extraction vecteur et calcul de la variance</span>
0420         PP=KK(tir,:);
0421         ret_KK=KK;
0422         ret_y=yy;
0423         ret_KK(pos,:)=[];
0424         ret_KK(:,pos)=[];
0425         ret_y(pos)=[];
0426         PP(pos)=[];
0427         <span class="keyword">if</span> ~aff_warning; warning off all;<span class="keyword">end</span>
0428         cv_varR(tir)=1-PP*(ret_KK\PP');
0429         <span class="comment">%calcul de la reponse</span>
0430         cv_zRn(tir)=PP*(ret_KK\ret_y);
0431         <span class="keyword">if</span> ~aff_warning; warning on all;<span class="keyword">end</span>
0432         <span class="comment">%retrait gradients</span>
0433         <span class="keyword">if</span> pres_grad
0434             <span class="keyword">for</span> pos_gr=1:nb_var
0435                 <span class="comment">%chargement des donnees</span>
0436                 pos=nb_val+(tir-1)*nb_var+pos_gr;
0437                 <span class="comment">%extraction vecteur</span>
0438                 dPP=KK(pos,:);
0439                 <span class="comment">%retrait des grandeurs</span>
0440                 ret_y=yy;
0441                 ret_KK=KK;
0442                 ret_y(pos,:)=[];
0443                 ret_KK(:,pos)=[];
0444                 ret_KK(pos,:)=[];
0445                 dPP(pos)=[];
0446                 <span class="comment">%calcul du gradients</span>
0447                 GZ=dPP*(ret_KK\ret_y);
0448                 cv_GZn(tir,pos_gr)=GZ;
0449             <span class="keyword">end</span>
0450         <span class="keyword">end</span>
0451     <span class="keyword">end</span>
0452     
0453     <span class="comment">%denormalisation</span>
0454     cv_zR=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(cv_zRn,<span class="string">'denorm'</span>,infos);
0455     cv_GZ=<a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>(cv_GZn,<span class="string">'denorm'</span>,infos);
0456     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0457     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0458     <span class="comment">%% Calcul des erreurs</span>
0459     [cv.then]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_zR,cv_varR,grad,cv_GZ,nb_val,nb_var,LOO_norm);
0460     <span class="comment">%affichage qques infos</span>
0461     <span class="keyword">if</span> mod_debug||mod_final
0462         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses PUIS gradients\n'</span>);
0463         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0464         <span class="keyword">if</span> pres_grad
0465             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0466             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0467         <span class="keyword">end</span>
0468         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0469         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.then.bm);
0470         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0471         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.then.errp);
0472         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0473         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0474         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0475         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0476     <span class="keyword">end</span>
0477     toc
0478 <span class="keyword">end</span>
0479 
0480 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0481 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0482 <span class="comment">%%Calcul de la variance  de prediction aux points echantillonnes (pour CV)</span>
0483 <span class="comment">%%%ATTENTION defaut pour cas avec gradients et/ou donnees manquantes</span>
0484 <span class="keyword">if</span> mod_final
0485     tic
0486     cv_varR=zeros(nb_val,1);
0487     KK=data_block.build.KK;
0488     parfor (tir=1:nb_val,numw)
0489         <span class="comment">%retrait des reponses seules</span>
0490         pos=tir;
0491         <span class="comment">%extraction vecteur et calcul de la variance</span>
0492         PP=KK(tir,:);
0493         ret_KK=KK;
0494         ret_KK(pos,:)=[];
0495         ret_KK(:,pos)=[];
0496         PP(pos)=[];
0497         <span class="keyword">if</span> ~aff_warning; warning off all;<span class="keyword">end</span>
0498         cv_varR(tir)=1-PP*(ret_KK\PP');
0499         <span class="keyword">if</span> ~aff_warning; warning on all;<span class="keyword">end</span>
0500     <span class="keyword">end</span>
0501     
0502     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0503     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0504     <span class="comment">%% Calcul des erreurs</span>
0505     [cv.final]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(zeros(size(esr)),-esr,cv_varR,[],[],nb_val,nb_var,LOO_norm);
0506     cv.then.scvr_min=cv.final.scvr_min;
0507     cv.then.scvr_max=cv.final.scvr_max;
0508     cv.then.scvr_mean=cv.final.scvr_mean;
0509     <span class="comment">%affichage qques infos</span>
0510     <span class="keyword">if</span> mod_debug||mod_final
0511         fprintf(<span class="string">'=== CV-LOO SCVR\n'</span>);
0512         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.final.scvr_min);
0513         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.final.scvr_max);
0514         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.final.scvr_mean);
0515     <span class="keyword">end</span>
0516     toc
0517 <span class="keyword">end</span>
0518 
0519 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0520 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0521 <span class="comment">%%Trace du graph QQ</span>
0522 <span class="keyword">if</span> meta.cv_aff&amp;&amp;mod_final
0523     <span class="comment">%normalisation</span>
0524     cv_zn=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(cv_z,<span class="string">'norm'</span>,infos);
0525     opt.newfig=false;
0526     figure
0527     subplot(3,2,1);
0528     opt.title=<span class="string">'Original data (CV R)'</span>;
0529     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data.in.eval,cv_zR,opt)
0530     subplot(3,2,2);
0531     opt.title=<span class="string">'Standardized data (CV R)'</span>;
0532     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data.in.evaln,cv_zRn,opt)
0533     subplot(3,2,3);
0534     opt.title=<span class="string">'Original data (CV F)'</span>;
0535     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data.in.eval,cv_z,opt)
0536     subplot(3,2,4);
0537     opt.title=<span class="string">'Standardized data (CV F)'</span>;
0538     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data.in.evaln,cv_zn,opt)
0539     subplot(3,2,5);
0540     opt.title=<span class="string">'SCVR'</span>;
0541     opt.xlabel=<span class="string">'Predicted'</span> ;
0542     opt.ylabel=<span class="string">'SCVR'</span>;
0543     <a href="../../../GRENAT/routines/aff/scvr_plot.html" class="code" title="function scvr_plot(Zap,scvr,opt)">scvr_plot</a>(cv_zRn,cv.final.scvr,opt)
0544 <span class="keyword">end</span>
0545 <span class="comment">%</span>
0546 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0547 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0548 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0549 
0550 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 27-Aug-2015 11:57:14 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>