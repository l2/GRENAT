<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of bloc_krg_ckrg</title>
  <meta name="keywords" content="bloc_krg_ckrg">
  <meta name="description" content="% Construction des blocs du Krigeage">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html GRENAT --><!-- # routines --><!-- menu.html meta -->
<h1>bloc_krg_ckrg
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>% Construction des blocs du Krigeage</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [lilog,ret]=bloc_krg_ckrg(donnees,meta,para) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Construction des blocs du Krigeage
%L. LAURENT -- 05/01/2011 -- laurent@lmt.ens-cachan.fr</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="likelihood.html" class="code" title="function [logli,li]=likelihood(donnees)">likelihood</a>	%Fonction permettant le calcul de la vraisemblance et de la log</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="estim_para_krg_ckrg.html" class="code" title="function para_estim=estim_para_krg_ckrg(donnees,meta)">estim_para_krg_ckrg</a>	% Fonction assurant l'estimation des parametres (longueur de correlation)</li><li><a href="meta_krg_ckrg.html" class="code" title="function [ret]=meta_krg_ckrg(tirages,eval,grad,meta,manq)">meta_krg_ckrg</a>	% fonction de construction des metamodeles de Krigeage et de Cokrigeage</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% Construction des blocs du Krigeage</span>
0002 <span class="comment">%%L. LAURENT -- 05/01/2011 -- laurent@lmt.ens-cachan.fr</span>
0003 
0004 
0005 <a name="_sub0" href="#_subfunctions" class="code">function [lilog,ret]=bloc_krg_ckrg(donnees,meta,para)</a>
0006 
0007 <span class="comment">%coefficient de reconditionnement</span>
0008 coef=(10+size(donnees.build.fct,1))*eps;
0009 <span class="comment">% type de factorisation de la matrice de correlation</span>
0010 <span class="keyword">if</span> strcmp(meta.type,<span class="string">'CKRG'</span>)
0011     fact_rcc=<span class="string">'LU'</span>;
0012 <span class="keyword">else</span>
0013     fact_rcc=<span class="string">'LU'</span> ; <span class="comment">%LU %QR %LL %None</span>
0014 <span class="keyword">end</span>
0015 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0016 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0017 <span class="comment">%chargement grandeurs utiles</span>
0018 nb_val=donnees.in.nb_val;
0019 nb_var=donnees.in.nb_var;
0020 tiragesn=donnees.in.tiragesn;
0021 fct_corr=meta.corr;
0022 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0023 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0024 <span class="comment">%si para defini alors on charge cette nouvelle valeur</span>
0025 final=false;
0026 <span class="keyword">if</span> nargin==3
0027     para_val=para;
0028 <span class="keyword">else</span>
0029     para_val=meta.para.val;
0030     final=true;
0031 <span class="keyword">end</span>
0032 ret=[];
0033 
0034 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0035 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0036 <span class="comment">%creation matrice de correlation</span>
0037 <span class="keyword">if</span> donnees.in.pres_grad
0038     <span class="comment">%si parallelisme actif ou non</span>
0039     <span class="keyword">if</span> meta.worker_parallel&gt;=2
0040         <span class="comment">%%%%%% PARALLEL %%%%%%</span>
0041         <span class="comment">%morceaux de la matrice GKRG</span>
0042         rc=zeros(nb_val,nb_val);
0043         rca=cell(1,nb_val);
0044         rci=cell(1,nb_val);
0045         parfor ii=1:nb_val
0046             <span class="comment">%distance 1 tirages aux autres (construction par colonne)</span>
0047             one_tir=tiragesn(ii,:);
0048             dist=one_tir(ones(1,nb_val),:)-tiragesn;
0049             <span class="comment">% evaluation de la fonction de correlation</span>
0050             [ev,dev,ddev]=feval(fct_corr,dist,para_val);
0051             <span class="comment">%morceau de la matrice issue du modele KRG classique</span>
0052             rc(:,ii)=ev;
0053             <span class="comment">%morceau des derivees premieres</span>
0054             rca{ii}=dev;
0055             <span class="comment">%matrice des derivees secondes</span>
0056             rci{ii}=-reshape(ddev,nb_var,nb_val*nb_var);
0057         <span class="keyword">end</span>
0058         <span class="comment">%%construction des matrices completes</span>
0059         rcaC=horzcat(rca{:});
0060         rciC=vertcat(rci{:});
0061         <span class="comment">%Matrice de complete</span>
0062         rcc=[rc rcaC;rcaC' rciC];
0063     <span class="keyword">else</span>
0064 
0065         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0066         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0067         <span class="comment">%evaluation de la fonction de correlation pour les differents</span>
0068         <span class="comment">%intersites</span>
0069         [ev,dev,ddev]=feval(fct_corr,donnees.in.dist,para_val);        
0070         
0071         <span class="comment">%morceau de la matrice issu du krigeage</span>
0072         rc=zeros(nb_val,nb_val);
0073         rca=zeros(nb_val,nb_var*nb_val);
0074         rci=zeros(nb_val*nb_var,nb_val*nb_var);
0075         
0076         rc(donnees.ind.matrix)=ev;
0077         rc=rc+rc'-eye(donnees.in.nb_val);
0078         
0079         rca(donnees.ind.matrixA)=dev(donnees.ind.dev);
0080         rca(donnees.ind.matrixAb)=-dev(donnees.ind.devb);
0081         rci(donnees.ind.matrixI)=-ddev(:);
0082         <span class="comment">%extraction de la diagonale (procedure pour eviter les doublons)</span>
0083         diago=0;   <span class="comment">% //!!\\ corrections envisageables ici</span>
0084         val_diag=spdiags(rci,diago);
0085         rci=rci+rci'-spdiags(val_diag,diago,zeros(size(rci))); <span class="comment">%correction termes diagonaux pour eviter les doublons</span>
0086 
0087         <span class="comment">%Matrice de correlation du Cokrigeage</span>
0088         rcc=[rc rca;rca' rci];
0089     <span class="keyword">end</span>
0090     <span class="comment">%si donnees manquantes</span>
0091     <span class="keyword">if</span> donnees.manq.eval.on
0092         rcc(donnees.manq.eval.ix_manq,:)=[];
0093         rcc(:,donnees.manq.eval.ix_manq)=[];
0094     <span class="keyword">end</span>
0095     
0096     <span class="comment">%si donnees manquantes</span>
0097     <span class="keyword">if</span> donnees.manq.grad.on
0098         rep_ev=nb_val-donnees.manq.eval.nb;
0099         rcc(rep_ev+donnees.manq.grad.ixt_manq_line,:)=[];
0100         rcc(:,rep_ev+donnees.manq.grad.ixt_manq_line)=[];
0101     <span class="keyword">end</span>
0102 <span class="keyword">else</span>
0103     
0104     <span class="keyword">if</span> meta.worker_parallel&gt;=2
0105         <span class="comment">%%%%%% PARALLEL %%%%%%</span>
0106         <span class="comment">%matrice de KRG classique par bloc</span>
0107         rcc=zeros(nb_val,nb_val);
0108         parfor ii=1:nb_val
0109             <span class="comment">%distance 1 tirages aux autres (construction par colonne)</span>
0110             one_tir=tiragesn(ii,:);
0111             dist=one_tir(ones(1,nb_val),:)-tiragesn;
0112             <span class="comment">% evaluation de la fonction de correlation</span>
0113             [ev]=feval(fct_corr,dist,para_val);
0114             <span class="comment">%morceau de la matrice issue du modele RBF classique</span>
0115             rcc(:,ii)=ev;
0116         <span class="keyword">end</span>
0117     <span class="keyword">else</span>        
0118         <span class="comment">%matrice de correlation du Krigeage par matrice triangulaire inferieure</span>
0119         <span class="comment">%sans diagonale</span>
0120         rcc=zeros(nb_val,nb_val);
0121         <span class="comment">% evaluation de la fonction de correlation</span>
0122         [ev]=feval(fct_corr,donnees.in.dist,para_val);
0123         rcc(donnees.ind.matrix)=ev;
0124         <span class="comment">%Construction matrice complete</span>
0125         rcc=rcc+rcc'+eye(nb_val);
0126     <span class="keyword">end</span>
0127     <span class="comment">%toc</span>
0128     <span class="comment">%si donnees manquantes</span>
0129     <span class="keyword">if</span> donnees.manq.eval.on
0130         rcc(donnees.manq.eval.ix_manq,:)=[];
0131         rcc(:,donnees.manq.eval.ix_manq)=[];
0132     <span class="keyword">end</span>
0133 <span class="keyword">end</span>
0134 
0135 <span class="comment">%passage en sparse</span>
0136 <span class="comment">%rcc=sparse(rcc);</span>
0137 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0138 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0139 <span class="comment">%amelioration du conditionnement de la matrice de correlation</span>
0140 <span class="keyword">if</span> meta.recond
0141     <span class="comment">%cond_orig=condest(rcc);</span>
0142     rcc=rcc+coef*speye(size(rcc));
0143     <span class="comment">%cond_new=condest(rcc);</span>
0144     <span class="comment">%fprintf('&gt;&gt;&gt; Amelioration conditionnement: \n%g &gt;&gt; %g  &lt;&lt;&lt;\n',...</span>
0145     <span class="comment">%    cond_orig,cond_new);</span>
0146     
0147 <span class="keyword">end</span>
0148 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0149 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0150 <span class="comment">%conditionnement de la matrice de correlation</span>
0151 <span class="keyword">if</span> final   <span class="comment">%en phase de construction</span>
0152     cond_new=condest(rcc);
0153     fprintf(<span class="string">'Conditionnement R: %6.5e\n'</span>,cond_new)
0154 <span class="keyword">end</span>
0155 
0156 
0157 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0158 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0159 <span class="comment">%approche factorisee</span>
0160 <span class="keyword">switch</span> fact_rcc
0161     <span class="keyword">case</span> <span class="string">'QR'</span>
0162         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0163         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0164         <span class="comment">%factorisation QR de la matrice de covariance</span>
0165         [Qrcc,Rrcc,Prcc]=qr(rcc);
0166         Qtrcc=Qrcc';
0167         yQ=Qtrcc*donnees.build.y;
0168         fctQ=Qtrcc*donnees.build.fct;
0169         fcR=donnees.build.fc*Prcc/Rrcc;
0170         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0171         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0172         <span class="comment">%calcul du coefficient beta</span>
0173         <span class="comment">%%approche classique</span>
0174         fcCfct=fcR*fctQ;
0175         block2=fcR*yQ;
0176         beta=fcCfct\block2;
0177         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0178         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0179         <span class="comment">%calcul du coefficient gamma</span>
0180         gamma=Prcc*(Rrcc\(yQ-fctQ*beta));
0181         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0182         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0183         <span class="comment">%sauvegarde variables</span>
0184         build_data.yQ=yQ;
0185         build_data.fctQ=fctQ;
0186         build_data.fcR=fcR;
0187         build_data.fcCfct=fcCfct;
0188         build_data.Rrcc=Rrcc;
0189         build_data.Qrcc=Qrcc;
0190         build_data.Qtrcc=Qtrcc;
0191         build_data.Prcc=Prcc;
0192         
0193     <span class="keyword">case</span> <span class="string">'LU'</span>
0194         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0195         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0196         <span class="comment">%factorisation LU de la matrice de covariance</span>
0197         [Lrcc,Urcc,Prcc]=lu(rcc,<span class="string">'vector'</span>);
0198         yP=donnees.build.y(Prcc,:);
0199         fctP=donnees.build.fct(Prcc,:);
0200         yL=Lrcc\yP;
0201         fctL=Lrcc\fctP;
0202         fcU=donnees.build.fc/Urcc;
0203         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0204         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0205         <span class="comment">%calcul du coefficient beta</span>
0206         <span class="comment">%%approche classique</span>
0207         fcCfct=fcU*fctL;
0208         block2=fcU*yL;
0209         beta=fcCfct\block2;
0210         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0211         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0212         <span class="comment">%calcul du coefficient gamma</span>
0213         gamma=Urcc\(yL-fctL*beta);
0214         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0215         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0216         <span class="comment">%sauvegarde variables</span>
0217         build_data.yL=yL;
0218         build_data.fcU=fcU;
0219         build_data.fctL=fctL;
0220         build_data.fcCfct=fcCfct;
0221         build_data.Lrcc=Lrcc;
0222         build_data.Urcc=Urcc;
0223         build_data.Prcc=Prcc;
0224     <span class="keyword">case</span> <span class="string">'LL'</span>
0225         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0226         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0227         <span class="comment">%factorisation Cholesky de la matrice de covariance</span>
0228         <span class="comment">%%% A debugguer</span>
0229         Lrcc=chol(rcc,<span class="string">'lower'</span>);
0230         Ltrcc=Lrcc';
0231         yL=Lrcc\donnees.build.y;
0232         fctL=Lrcc\donnees.build.fct;
0233         fcL=donnees.build.fc/Ltrcc;
0234         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0235         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0236         <span class="comment">%calcul du coefficient beta</span>
0237         fcCfct=fcL*fctL;
0238         block2=fcL*yL;
0239         beta=fcCfct\block2;
0240         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0241         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0242         <span class="comment">%calcul du coefficient gamma</span>
0243         gamma=Ltrcc\(yL-fctL*beta);
0244         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0245         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0246         <span class="comment">%sauvegarde variables</span>
0247         build_data.yL=yL;
0248         build_data.fcL=fcL;
0249         build_data.fctL=fctL;
0250         build_data.fcCfct=fcCfct;
0251         build_data.Ltrcc=Ltrcc;
0252         build_data.Lrcc=Lrcc;
0253     <span class="keyword">otherwise</span>
0254         
0255         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0256         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0257         <span class="comment">%calcul des coefficients beta et gamma</span>
0258         <span class="comment">%%approche classique</span>
0259         fcC=donnees.build.fc/rcc;
0260         fcCfct=fcC*donnees.build.fct;
0261         block2=((donnees.build.fc/rcc)*donnees.build.y);
0262         beta=fcCfct\block2;
0263         gamma=rcc\(donnees.build.y-donnees.build.fct*beta);
0264         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0265         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0266         <span class="comment">%sauvegarde variables</span>
0267         build_data.fcC=fcC;
0268         build_data.fcCfct=fcCfct;
0269 <span class="keyword">end</span>
0270 
0271 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0272 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0273 <span class="comment">%sauvegarde de donnees</span>
0274 <span class="keyword">if</span> exist(<span class="string">'cond_orig'</span>,<span class="string">'var'</span>);build_data.cond_orig=cond_orig;<span class="keyword">end</span>
0275 <span class="keyword">if</span> exist(<span class="string">'cond_new'</span>,<span class="string">'var'</span>);build_data.cond_new=cond_new;<span class="keyword">end</span>
0276 
0277 build_data.beta=beta;
0278 build_data.gamma=gamma;
0279 build_data.rcc=rcc;
0280 build_data.deg=meta.deg;
0281 build_data.para=meta.para;
0282 build_data.fact_rcc=fact_rcc;
0283 ret.build=build_data;
0284 
0285 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0286 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0287 <span class="comment">%variance de prediction</span>
0288 ret.build.sig2=1/size(rcc,1)*<span class="keyword">...</span>
0289     ((donnees.build.y-donnees.build.fct*ret.build.beta)'*ret.build.gamma);
0290 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0291 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0292 <span class="comment">%Maximum de vraisemblance</span>
0293 [ret.lilog,ret.li]=<a href="likelihood.html" class="code" title="function [logli,li]=likelihood(donnees)">likelihood</a>(ret);
0294 lilog=ret.lilog;
0295 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0296 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0297 <span class="comment">%denormalisation sigma^2</span>
0298 <span class="keyword">if</span> meta.norm&amp;&amp;~isempty(donnees.norm.std_eval)
0299     ret.build.sig2=ret.build.sig2*donnees.norm.std_eval^2;
0300 <span class="keyword">else</span>
0301     ret.build.sig2=ret.build.sig2;
0302 <span class="keyword">end</span>
0303 
0304</pre></div>
<hr><address>Generated on Thu 27-Aug-2015 11:57:14 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>