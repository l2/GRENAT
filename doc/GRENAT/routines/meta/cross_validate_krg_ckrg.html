<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cross_validate_krg_ckrg</title>
  <meta name="keywords" content="cross_validate_krg_ckrg">
  <meta name="description" content="% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas du Krigeage/CoKrigeage">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html GRENAT --><!-- # routines --><!-- menu.html meta -->
<h1>cross_validate_krg_ckrg
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas du Krigeage/CoKrigeage</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function cv=cross_validate_krg_ckrg(data_block,meta,type) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas du Krigeage/CoKrigeage
L. LAURENT -- 14/12/2011 -- laurent@lmt.ens-cachan.fr
nouvelle version du 19/10/2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>	% Trace QQ plot (pour cross validation)</li><li><a href="../../../GRENAT/routines/aff/scvr_plot.html" class="code" title="function scvr_plot(Zap,scvr,opt)">scvr_plot</a>	% Trace SCVR plot (pour cross validation)</li><li><a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>	% Procedure de calcul des erreurs par LOO</li><li><a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>	% fonction assurant la normalisation/denormalisation des donnees</li><li><a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>	% fonction assurant la normalisation/denormalisation des donnees de type gradients</li><li><a href="eval_krg_ckrg.html" class="code" title="function [Z,GZ,variance,details]=eval_krg_ckrg(U,donnees,tir_part)">eval_krg_ckrg</a>	% Fonction assurant l'evaluation du metamodele de Krigeage ou de Cokrigeage</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="meta_krg_ckrg.html" class="code" title="function [ret]=meta_krg_ckrg(tirages,eval,grad,meta,manq)">meta_krg_ckrg</a>	% fonction de construction des metamodeles de Krigeage et de Cokrigeage</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function ret_etat=mod_warning(etat_demande,old_etat)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% Fonction assurant le calcul de diverses erreurs par validation croisee dans le cas du Krigeage/CoKrigeage</span>
0002 <span class="comment">%L. LAURENT -- 14/12/2011 -- laurent@lmt.ens-cachan.fr</span>
0003 <span class="comment">%nouvelle version du 19/10/2012</span>
0004 
0005 <a name="_sub0" href="#_subfunctions" class="code">function cv=cross_validate_krg_ckrg(data_block,meta,type)</a>
0006 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0007 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0008 <span class="comment">%%%%%%%%%% OPTIONS</span>
0009 <span class="comment">%norme employee dans le calcul de l'erreur LOO</span>
0010 <span class="comment">%MSE: norme-L2</span>
0011 LOO_norm=<span class="string">'L2'</span>;
0012 <span class="comment">%debug</span>
0013 debug=false;
0014 
0015 <span class="comment">% affichages warning ou non</span>
0016 aff_warning=false;
0017 state_warning=<a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>([],[]);
0018 <span class="comment">%denormalisation des grandeurs pour calcul CV</span>
0019 denorm_cv=true;
0020 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0021 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0022 <span class="keyword">if</span> denorm_cv;denorm_cv=data_block.norm.on;<span class="keyword">end</span>
0023 
0024 <span class="comment">%differents cas de figure</span>
0025 mod_debug=debug;mod_etud=meta.cv_full;mod_final=false;
0026 <span class="keyword">if</span> nargin==3
0027     <span class="keyword">switch</span> type
0028         <span class="keyword">case</span> <span class="string">'debug'</span> <span class="comment">%mode debug (grandeurs affichees)</span>
0029             fprintf(<span class="string">'+++ CV KRG en mode DEBUG\n'</span>);
0030             mod_debug=true;
0031         <span class="keyword">case</span> <span class="string">'etud'</span>  <span class="comment">%mode etude (calcul des criteres par les deux methodes</span>
0032             mod_etud=true;
0033         <span class="keyword">case</span> <span class="string">'estim'</span>  <span class="comment">%mode estimation</span>
0034             mod_etud=false;
0035             <span class="comment">% case 'nominal'  %mode nominal (calcul des criteres par la methode de Rippa)</span>
0036         <span class="keyword">case</span> <span class="string">'final'</span>    <span class="comment">%mode final (calcul des variances)</span>
0037             mod_final=true;
0038     <span class="keyword">end</span>
0039 <span class="keyword">else</span>
0040     mod_final=true;
0041 <span class="keyword">end</span>
0042 
0043 <span class="keyword">if</span> mod_debug||mod_etud
0044     condRcc=condest(data_block.build.rcc);
0045     <span class="keyword">if</span> condRcc&gt;1e12
0046         fprintf(<span class="string">'+++ //!\\ Mauvais conditionnement (%4.2e)\n'</span>,condRcc);
0047     <span class="keyword">end</span>
0048 <span class="keyword">end</span>
0049 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0050 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0051 <span class="comment">%chargement des grandeurs</span>
0052 nb_var=data_block.in.nb_var;
0053 nb_val=data_block.in.nb_val;
0054 norm_on=data_block.norm.on;
0055 pres_grad=data_block.in.pres_grad;
0056 moy_eval=data_block.norm.moy_eval;
0057 std_eval=data_block.norm.std_eval;
0058 std_tirages=data_block.norm.std_tirages;
0059 
0060 <span class="keyword">if</span> mod_final;tic;<span class="keyword">end</span>
0061 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0062 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0063 <span class="comment">%%% Adaptation de la methode de Rippa (Rippa 1999/Fasshauer 2007) par M. Bompard (Bompard 2011)</span>
0064 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0065 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0066 <span class="comment">%coefficient du Krigegae</span>
0067 coef_KRG=data_block.build.gamma;
0068 <span class="comment">%extraction partielle de la diagonale de l'inverse de la matrice de</span>
0069 <span class="comment">%Krigeage</span>
0070 <span class="keyword">switch</span> data_block.build.fact_rcc
0071     <span class="keyword">case</span> <span class="string">'QR'</span>
0072         fcC=data_block.build.fcR*data_block.build.Qtrcc;
0073         diagMK=diag(data_block.build.Rrcc\data_block.build.Qtrcc)-<span class="keyword">...</span>
0074             diag(fcC'*(data_block.build.fcCfct\fcC));
0075     <span class="keyword">case</span> <span class="string">'LU'</span>
0076         fcC=data_block.build.fcU/data_block.build.Lrcc;
0077         diagMK=diag(data_block.build.Urcc\inv(data_block.build.Lrcc))-<span class="keyword">...</span>
0078             diag(fcC'*(data_block.build.fcCfct\fcC));
0079     <span class="keyword">case</span> <span class="string">'LL'</span>
0080         fcC=data_block.build.fcL/data_block.build.Lrcc;
0081         diagMK=diag(data_block.build.Lrcc\inv(data_block.build.Lrcc))-<span class="keyword">...</span>
0082             diag(fcC'*(data_block.build.fcCfct\fcC));
0083     <span class="keyword">otherwise</span>
0084         diagMK=diag(inv(data_block.build.rcc))-<span class="keyword">...</span>
0085             diag(data_block.build.fcC'*(data_block.build.fcCfct\data_block.build.fcC));
0086         
0087 <span class="keyword">end</span>
0088 <span class="comment">%vecteurs des ecarts aux echantillons retires (reponses et gradients)</span>
0089 esn=coef_KRG./diagMK;
0090 
0091 <span class="comment">%denormalisation des grandeurs</span>
0092 infos.moy=moy_eval;
0093 infos.std=std_eval;infos.std_e=infos.std;
0094 infos.std_t=std_tirages;
0095 <span class="keyword">if</span> pres_grad
0096     <span class="keyword">if</span> norm_on&amp;&amp;denorm_cv
0097         <span class="comment">%denormalisation difference reponses</span>
0098         esr=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(esn(1:nb_val),<span class="string">'denorm_diff'</span>,infos);
0099         <span class="comment">%denormalisation difference gradients</span>
0100         esg=<a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>(esn(nb_val+1:end),<span class="string">'denorm_concat'</span>,infos);
0101         es=[esr;esg];
0102     <span class="keyword">else</span>
0103         esr=esn(1:nb_val);
0104         esg=esn(nb_val+1:end);
0105         es=esn;
0106     <span class="keyword">end</span>
0107 <span class="keyword">else</span>
0108     <span class="keyword">if</span> norm_on&amp;&amp;denorm_cv
0109         es=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(esn,<span class="string">'denorm_diff'</span>,infos);
0110     <span class="keyword">else</span>
0111         es=esn;
0112     <span class="keyword">end</span>
0113     esr=es;
0114 <span class="keyword">end</span>
0115 
0116 <span class="comment">%calcul des erreurs en reponses et en gradients (differentes normes</span>
0117 <span class="comment">%employees)</span>
0118 <span class="keyword">switch</span> LOO_norm
0119     <span class="keyword">case</span> <span class="string">'L1'</span>
0120         <span class="keyword">if</span> pres_grad
0121             cv.then.press=esr'*esr;
0122             cv.then.eloor=1/nb_val*sum(abs(esr));
0123             cv.then.eloog=1/(nb_val*nb_var)*sum(abs(esg));
0124             cv.then.eloot=1/(nb_val*(nb_var+1))*sum(abs(es));
0125             cv.press=cv.then.press;
0126             cv.eloor=cv.then.eloor;
0127             cv.eloog=cv.then.eloog;
0128             cv.eloot=cv.then.eloot;
0129         <span class="keyword">else</span>
0130             cv.then.press=es'*es;
0131             cv.then.eloot=1/nb_val*sum(abs(es));
0132             cv.press=cv.then.press;
0133             cv.eloot=cv.then.eloot;
0134         <span class="keyword">end</span>
0135     <span class="keyword">case</span> <span class="string">'L2'</span> <span class="comment">%MSE</span>
0136         <span class="keyword">if</span> pres_grad
0137             cv.then.press=esr'*esr;
0138             cv.then.eloor=1/nb_val*(cv.then.press);
0139             cv.then.eloog=1/(nb_val*nb_var)*(esg'*esg);
0140             cv.then.eloot=1/(nb_val*(nb_var+1))*(es'*es);
0141             cv.press=cv.then.press;
0142             cv.eloor=cv.then.eloor;
0143             cv.eloog=cv.then.eloog;
0144             cv.eloot=cv.then.eloot;
0145         <span class="keyword">else</span>
0146             cv.then.press=es'*es;
0147             cv.then.eloot=1/nb_val*(cv.then.press);
0148             cv.press=cv.then.press;
0149             cv.eloot=cv.then.eloot;
0150         <span class="keyword">end</span>
0151     <span class="keyword">case</span> <span class="string">'Linf'</span>
0152         <span class="keyword">if</span> pres_grad
0153             cv.then.press=esr'*esr;
0154             cv.then.eloor=1/nb_val*max(esr(:));
0155             cv.then.eloog=1/(nb_val*nb_var)*max(esg(:));
0156             cv.then.eloot=1/(nb_val*(nb_var+1))*max(es(:));
0157             cv.press=cv.then.press;
0158             cv.eloor=cv.then.eloor;
0159             cv.eloog=cv.then.eloog;
0160             cv.eloot=cv.then.eloot;
0161         <span class="keyword">else</span>
0162             cv.then.press=es'*es;
0163             cv.then.eloot=1/nb_val*max(es(:));
0164             cv.press=cv.then.press;
0165             cv.eloot=cv.then.eloot;
0166         <span class="keyword">end</span>
0167 <span class="keyword">end</span>
0168 <span class="comment">%biais moyen</span>
0169 cv.bm=1/nb_val*sum(esr);
0170 <span class="comment">%affichage qques infos</span>
0171 <span class="keyword">if</span> mod_debug||mod_final
0172     fprintf(<span class="string">'\n'</span>)
0173     fprintf(<span class="string">'=== CV-LOO par methode de Rippa 1999 (extension Bompard 2011)\n'</span>);
0174     fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0175     <span class="keyword">if</span> pres_grad
0176         fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0177         fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0178     <span class="keyword">end</span>
0179     fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0180     fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0181 <span class="keyword">end</span>
0182 <span class="keyword">if</span> mod_final;toc;<span class="keyword">end</span>
0183 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0184 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0185 <span class="comment">%%% Methode CV classique (retrait SUCCESSIVE des reponses et gradients)</span>
0186 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0187 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0188 <span class="keyword">if</span> mod_debug
0189     tic
0190     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0191     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0192     <span class="comment">%stockage des evaluations du metamodele au point enleve</span>
0193     cv_z=zeros(nb_val,1);
0194     cv_var=zeros(nb_val,1);
0195     cv_gz=zeros(nb_val,nb_var);
0196     yy=data_block.build.y;
0197     fct=data_block.build.fct;
0198     rcc=data_block.build.rcc;
0199     tirages=data_block.in.tirages;
0200     tiragesn=data_block.in.tiragesn;
0201     grad=data_block.in.grad;
0202     eval=data_block.in.eval;
0203     dim_c=data_block.build.dim_fc;
0204     <span class="comment">%parcours des echantillons</span>
0205     <span class="keyword">for</span> tir=1:nb_val
0206         <span class="comment">%chargement des donnees</span>
0207         donnees_cv=data_block;
0208         <span class="comment">%retrait des grandeurs</span>
0209         cv_y=yy([1:(tir-1) (tir+1):end]');
0210         cv_rcc=rcc([1:(tir-1) (tir+1):end],[1:(tir-1) (tir+1):end]);
0211         cv_fct=fct([1:(tir-1) (tir+1):end],:);
0212         
0213         cv_fcC=cv_fct'/cv_rcc;
0214         cv_fcCfct=cv_fcC*cv_fct;
0215         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0216         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0217         <span class="comment">%calcul des coefficients</span>
0218         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(aff_warning);
0219         donnees_cv.build.fact_rcc=<span class="string">'None'</span>;
0220         cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0221         cv_iMKrg=inv(cv_MKrg);
0222         coefKRG=cv_iMKrg*[cv_y;zeros(dim_c,1)];
0223         
0224         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0225         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0226         <span class="comment">%extraction coefficients beta et gamma</span>
0227         donnees_cv.build.beta=coefKRG((end-dim_c+1):end);
0228         donnees_cv.build.gamma=coefKRG(1:(end-dim_c));
0229         donnees_cv.build.rcc=cv_rcc;
0230         
0231         <span class="comment">%calcul de la variance de prediction</span>
0232         sig2=1/size(cv_rcc,1)*((cv_y-cv_fct*donnees_cv.build.beta)'*donnees_cv.build.gamma);
0233         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(~aff_warning);
0234         
0235         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0236         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0237         <span class="keyword">if</span> norm_on
0238             donnees_cv.build.sig2=sig2*std_eval^2;
0239         <span class="keyword">else</span>
0240             donnees_cv.build.sig2=sig2;
0241         <span class="keyword">end</span>
0242         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0243         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0244         <span class="comment">%passage des parametres</span>
0245         donnees_cv.in.tirages=tirages;
0246         donnees_cv.in.tiragesn=tiragesn;
0247         donnees_cv.in.nb_val=nb_val;  <span class="comment">%retrait d'un site</span>
0248         donnees_cv.build.fct=cv_fct;
0249         donnees_cv.build.fc=cv_fct';
0250         donnees_cv.build.fcCfct=cv_fcCfct;
0251         donnees_cv.enrich.on=false;
0252         <span class="comment">%on retire la reponse associe</span>
0253         donnees_cv.manq.grad.on=false;
0254         donnees_cv.manq.eval.on=true;
0255         donnees_cv.manq.eval.ix_manq=tir;
0256         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0257         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0258         <span class="comment">%%Evaluation du metamodele au point supprime de la construction</span>
0259         [cv_z(tir),~,cv_var(tir)]=<a href="eval_krg_ckrg.html" class="code" title="function [Z,GZ,variance,details]=eval_krg_ckrg(U,donnees,tir_part)">eval_krg_ckrg</a>(tirages(tir,:),donnees_cv);
0260         <span class="comment">%retrait gradients</span>
0261         <span class="keyword">if</span> pres_grad
0262             <span class="keyword">for</span> pos_gr=1:nb_var
0263                 <span class="comment">%chargement des donnees</span>
0264                 donnees_cv=data_block;
0265                 pos=nb_val+(tir-1)*nb_var+pos_gr;
0266                 <span class="comment">%retrait des grandeurs</span>
0267                 cv_y=yy([1:(pos-1) (pos+1):end]');
0268                 cv_rcc=rcc([1:(pos-1) (pos+1):end],[1:(pos-1) (pos+1):end]);
0269                 cv_fct=fct([1:(pos-1) (pos+1):end],:);
0270                 cv_fcC=cv_fct'/cv_rcc;
0271                 cv_fcCfct=cv_fcC*cv_fct;
0272                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0273                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0274                 <span class="comment">%calcul des coefficients</span>
0275                 <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(aff_warning);
0276                 donnees_cv.build.fact_rcc=<span class="string">'None'</span>;
0277                 cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0278                 cv_iMKrg=inv(cv_MKrg);
0279                 coefKRG=cv_iMKrg*[cv_y;zeros(dim_c,1)];
0280                 
0281                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0282                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0283                 <span class="comment">%extraction coefficients beta et gamma</span>
0284                 donnees_cv.build.beta=coefKRG((end-dim_c+1):end);
0285                 donnees_cv.build.gamma=coefKRG(1:(end-dim_c));
0286                 donnees_cv.build.rcc=cv_rcc;
0287                 
0288                 <span class="comment">%calcul de la variance de prediction</span>
0289                 sig2=1/size(cv_rcc,1)*((cv_y-cv_fct*donnees_cv.build.beta)'*donnees_cv.build.gamma);
0290                 <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(~aff_warning);
0291                 
0292                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0293                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0294                 <span class="keyword">if</span> norm_on
0295                     donnees_cv.build.sig2=sig2*std_eval^2;
0296                 <span class="keyword">else</span>
0297                     donnees_cv.build.sig2=sig2;
0298                 <span class="keyword">end</span>
0299                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0300                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0301                 <span class="comment">%passage des parametres</span>
0302                 donnees_cv.in.tirages=tirages;
0303                 donnees_cv.in.tiragesn=tiragesn;
0304                 donnees_cv.in.nb_val=nb_val;  <span class="comment">%retrait d'un site</span>
0305                 donnees_cv.build.fct=cv_fct;
0306                 donnees_cv.build.fc=cv_fct';
0307                 donnees_cv.build.fcCfct=cv_fcCfct;
0308                 donnees_cv.enrich.on=false;
0309                 <span class="comment">%on retire le gradient associe</span>
0310                 donnees_cv.manq.grad.on=true;
0311                 donnees_cv.manq.eval.on=false;
0312                 donnees_cv.manq.grad.ixt_manq_line=pos-nb_val;
0313                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0314                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0315                 <span class="comment">%%Evaluation du metamodele au point supprime de la construction</span>
0316                 [~,GZ,~]=<a href="eval_krg_ckrg.html" class="code" title="function [Z,GZ,variance,details]=eval_krg_ckrg(U,donnees,tir_part)">eval_krg_ckrg</a>(tirages(tir,:),donnees_cv);
0317                 cv_gz(tir,pos_gr)=GZ(pos_gr);
0318             <span class="keyword">end</span>
0319         <span class="keyword">end</span>
0320     <span class="keyword">end</span>
0321     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0322     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0323     <span class="comment">%% Calcul des erreurs</span>
0324     [cv.then]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_z,cv_var,grad,cv_gz,nb_val,nb_var,LOO_norm);
0325     <span class="comment">%affichage qques infos</span>
0326     <span class="keyword">if</span> mod_debug
0327         fprintf(<span class="string">'\n'</span>)
0328         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses PUIS gradients (debug)\n'</span>);
0329         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0330         <span class="keyword">if</span> pres_grad
0331             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0332             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0333         <span class="keyword">end</span>
0334         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0335         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.then.bm);
0336         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0337         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.then.errp);
0338         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0339         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0340         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0341         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0342     <span class="keyword">end</span>
0343     toc
0344 <span class="keyword">end</span>
0345 
0346 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0347 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0348 <span class="comment">%%% Methode CV classique (retrait simultanee des reponses et gradient en</span>
0349 <span class="comment">%%% chaque echantillon)</span>
0350 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0351 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0352 <span class="keyword">if</span> mod_etud||mod_debug||meta.cv_aff
0353     tic
0354     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0355     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0356     <span class="comment">%stockage des evaluations du metamodele au point enleve</span>
0357     cv_z=zeros(nb_val,1);
0358     cv_var=zeros(nb_val,1);
0359     cv_gz=zeros(nb_val,nb_var);
0360     yy=data_block.build.y;
0361     fct=data_block.build.fct;
0362     rcc=data_block.build.rcc;
0363     tirages=data_block.in.tirages;
0364     tiragesn=data_block.in.tiragesn;
0365     grad=data_block.in.grad;
0366     eval=data_block.in.eval;
0367     dim_c=data_block.build.dim_fc;
0368     <span class="comment">%parcours des echantillons</span>
0369     <span class="keyword">for</span> tir=1:nb_val
0370         <span class="comment">%chargement des donnees</span>
0371         donnees_cv=data_block;
0372         <span class="comment">%retrait des grandeurs</span>
0373         <span class="keyword">if</span> pres_grad
0374             pos=[tir nb_val+(tir-1)*nb_var+(1:nb_var)];
0375             IX_i=1:((nb_var+1)*nb_val);
0376         <span class="keyword">else</span>
0377             pos=tir;
0378             IX_i=1:(nb_val);
0379         <span class="keyword">end</span>
0380         <span class="comment">%complement index initiaux</span>
0381         IX_c=IX_i(end)+(1:dim_c);
0382         <span class="comment">%index des elements a extraire</span>
0383         IX_e=setxor(IX_i,pos);
0384         
0385         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(aff_warning);
0386         cv_y=yy(IX_e');
0387         cv_rcc=rcc(IX_e,IX_e);
0388         cv_fct=fct(IX_e,:);
0389         cv_fcC=cv_fct'/cv_rcc;
0390         cv_fcCfct=cv_fcC*cv_fct;
0391         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0392         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0393         <span class="comment">%calcul des coefficients</span>
0394         
0395         donnees_cv.build.fact_rcc=<span class="string">'None'</span>;
0396         cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0397         cv_iMKrg=inv(cv_MKrg);
0398         coefKRG=cv_iMKrg*[cv_y;zeros(dim_c,1)];
0399         
0400         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0401         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0402         <span class="comment">%extraction coefficients beta et gamma</span>
0403         donnees_cv.build.beta=coefKRG((end-dim_c+1):end);
0404         donnees_cv.build.gamma=coefKRG(1:(end-dim_c));
0405         donnees_cv.build.rcc=cv_rcc;
0406         
0407         <span class="comment">%calcul de la variance de prediction</span>
0408         sig2=1/size(cv_rcc,1)*((cv_y-cv_fct*donnees_cv.build.beta)'*donnees_cv.build.gamma);
0409         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(~aff_warning);
0410         
0411         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0412         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0413         <span class="keyword">if</span> norm_on
0414             donnees_cv.build.sig2=sig2*std_eval^2;
0415         <span class="keyword">else</span>
0416             donnees_cv.build.sig2=sig2;
0417         <span class="keyword">end</span>
0418         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0419         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0420         <span class="comment">%passage des parametres</span>
0421         donnees_cv.in.tirages=tirages([1:(tir-1) (tir+1):end],:);
0422         donnees_cv.in.tiragesn=tiragesn([1:(tir-1) (tir+1):end],:);
0423         donnees_cv.in.nb_val=nb_val-1;  <span class="comment">%retrait d'un site</span>
0424         donnees_cv.build.fct=cv_fct;
0425         donnees_cv.build.fc=cv_fct';
0426         donnees_cv.build.fcCfct=cv_fcCfct;
0427         donnees_cv.enrich.on=false;
0428         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0429         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0430         <span class="comment">%%Evaluation du metamodele au point supprime de la construction</span>
0431         [Z,GZ,variance]=<a href="eval_krg_ckrg.html" class="code" title="function [Z,GZ,variance,details]=eval_krg_ckrg(U,donnees,tir_part)">eval_krg_ckrg</a>(tirages(tir,:),donnees_cv);
0432         cv_z(tir)=Z;
0433         cv_gz(tir,:)=GZ;
0434         cv_var(tir)=variance;
0435     <span class="keyword">end</span>
0436     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0437     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0438     <span class="comment">%% Calcul des erreurs</span>
0439     [cv.and]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_z,cv_var,grad,cv_gz,nb_val,nb_var,LOO_norm);
0440     <span class="comment">%affichage qques infos</span>
0441     <span class="keyword">if</span> mod_debug||mod_final
0442         fprintf(<span class="string">'\n'</span>)
0443         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses ET gradients\n'</span>);
0444         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0445         <span class="keyword">if</span> pres_grad
0446             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.and.eloor);
0447             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.and.eloog);
0448         <span class="keyword">end</span>
0449         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.and.eloot);
0450         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.and.bm);
0451         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.and.press);
0452         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.and.errp);
0453         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.and.scvr_min);
0454         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.and.scvr_max);
0455         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.and.scvr_mean);
0456         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.and.adequ);
0457     <span class="keyword">end</span>
0458     toc
0459 <span class="keyword">end</span>
0460 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0461 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0462 <span class="comment">%%Calcul de la variance  de prediction aux points echantillonnes + test calcul reponses et gradients (pour CV)</span>
0463 <span class="comment">%%%ATTENTION defaut pour cas avec gradients et/ou donnees manquantes</span>
0464 <span class="keyword">if</span> meta.cv_aff||mod_debug
0465     tic
0466     cv_varR=zeros(nb_val,1);
0467     cv_zRn=zeros(nb_val,1);
0468     cv_GZn=zeros(nb_val,nb_var);
0469     yy=data_block.build.y;
0470     fct=data_block.build.fct;
0471     rcc=data_block.build.rcc;
0472     grad=data_block.in.grad;
0473     eval=data_block.in.eval;
0474     dim_c=data_block.build.dim_fc;
0475     <span class="keyword">for</span> tir=1:nb_val
0476         <span class="comment">%extraction des grandeurs</span>
0477         PP=[rcc(tir,:) fct(tir,:)];
0478         PP(tir)=[];
0479         cv_y=yy([1:(tir-1) (tir+1):end]');
0480         cv_rcc=rcc([1:(tir-1) (tir+1):end],[1:(tir-1) (tir+1):end]);
0481         cv_fct=fct([1:(tir-1) (tir+1):end],:);
0482         
0483         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0484         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0485         <span class="comment">%calcul des coefficients</span>
0486         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(aff_warning);
0487         cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0488         cv_iMKrg=inv(cv_MKrg);
0489         coefKRG=cv_iMKrg*[cv_y;zeros(dim_c,1)];
0490         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0491         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0492         <span class="comment">%extraction coefficients beta et gamma</span>
0493         beta=coefKRG((end-dim_c+1):end);
0494         gamma=coefKRG(1:(end-dim_c));
0495         <span class="comment">%calcul de la variance du processus</span>
0496         sig2=1/size(cv_rcc,1)*((cv_y-cv_fct*beta)'*gamma);
0497         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0498         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0499         <span class="keyword">if</span> norm_on
0500             sig2=sig2*std_eval^2;
0501         <span class="keyword">end</span>
0502         <span class="comment">%calcul de la variance de prediction</span>
0503         cv_varR(tir)=sig2*(1-PP*(cv_iMKrg*PP'));
0504         
0505         <span class="comment">%calcul de la reponse</span>
0506         cv_zRn(tir)=PP*coefKRG;
0507         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(~aff_warning);
0508         <span class="comment">%retrait gradients</span>
0509         <span class="keyword">if</span> pres_grad
0510             <span class="keyword">for</span> pos_gr=1:nb_var
0511                 pos=nb_val+(tir-1)*nb_var+pos_gr;
0512                 <span class="comment">%retrait des grandeurs</span>
0513                 cv_rcc=rcc([1:(pos-1) (pos+1):end],[1:(pos-1) (pos+1):end]);
0514                 cv_fct=fct([1:(pos-1) (pos+1):end],:);
0515                 cv_y=yy([1:(pos-1) (pos+1):end]');
0516                 cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0517                 <span class="comment">%extraction vecteur</span>
0518                 dPP=[rcc(pos,:) fct(pos,:)];
0519                 dPP(pos)=[];
0520                 <span class="comment">%calcul du gradients</span>
0521                 GZ=dPP*(cv_MKrg\[cv_y;zeros(dim_c,1)]);
0522                 cv_GZn(tir,pos_gr)=GZ;
0523             <span class="keyword">end</span>
0524         <span class="keyword">end</span>
0525     <span class="keyword">end</span>
0526     
0527     <span class="comment">%denormalisation</span>
0528     cv_zR=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(cv_zRn,<span class="string">'denorm'</span>,infos);
0529     cv_GZ=<a href="../../../GRENAT/routines/divers/norm_denorm_g.html" class="code" title="function [out]=norm_denorm_g(in,type,infos)">norm_denorm_g</a>(cv_GZn,<span class="string">'denorm'</span>,infos);
0530     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0531     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0532     <span class="comment">%% Calcul des erreurs</span>
0533     [cv.then]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(eval,cv_zR,cv_varR,grad,cv_GZ,nb_val,nb_var,LOO_norm);
0534     <span class="comment">%affichage qques infos</span>
0535     <span class="keyword">if</span> mod_debug||mod_final
0536         fprintf(<span class="string">'\n'</span>)
0537         fprintf(<span class="string">'=== CV-LOO par methode retrait reponses PUIS gradients\n'</span>);
0538         fprintf(<span class="string">'+++ Norme calcul CV-LOO: %s\n'</span>,LOO_norm);
0539         <span class="keyword">if</span> pres_grad
0540             fprintf(<span class="string">'+++ Erreur reponses %4.2e\n'</span>,cv.then.eloor);
0541             fprintf(<span class="string">'+++ Erreur gradient %4.2e\n'</span>,cv.then.eloog);
0542         <span class="keyword">end</span>
0543         fprintf(<span class="string">'+++ Erreur total %4.2e\n'</span>,cv.then.eloot);
0544         fprintf(<span class="string">'+++ Biais moyen %4.2e\n'</span>,cv.then.bm);
0545         fprintf(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0546         fprintf(<span class="string">'+++ Critere perso %4.2e\n'</span>,cv.then.errp);
0547         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0548         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0549         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0550         fprintf(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0551     <span class="keyword">end</span>
0552     toc
0553 <span class="keyword">end</span>
0554 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0555 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0556 <span class="comment">%%Calcul de la variance  de prediction aux points echantillonnes (pour CV)</span>
0557 <span class="comment">%%%ATTENTION defaut pour cas avec gradients et/ou donnees manquantes</span>
0558 <span class="keyword">if</span> mod_final
0559     tic
0560     cv_varR=zeros(nb_val,1);
0561     yy=data_block.build.y;
0562     fct=data_block.build.fct;
0563     rcc=data_block.build.rcc;
0564     dim_c=data_block.build.dim_fc;
0565     <span class="comment">%si parallelisme</span>
0566     numw=0;
0567     <span class="keyword">if</span> ~isempty(whos(<span class="string">'parallel'</span>,<span class="string">'global'</span>))
0568         <span class="keyword">global</span> parallel
0569         numw=parallel.num;
0570     <span class="keyword">end</span>
0571     parfor (tir=1:nb_val,numw)
0572         
0573         <span class="comment">%extraction des grandeurs</span>
0574         PP=[rcc(tir,:) fct(tir,:)];
0575         PP(tir)=[];
0576         cv_rcc=rcc([1:(tir-1) (tir+1):end],[1:(tir-1) (tir+1):end]);
0577         cv_fct=fct([1:(tir-1) (tir+1):end],:);
0578         cv_y=yy([1:(tir-1) (tir+1):end]');
0579         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0580         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0581         <span class="comment">%calcul des coefficients</span>
0582         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(aff_warning);
0583         cv_MKrg=[cv_rcc cv_fct;cv_fct' zeros(dim_c)];
0584         cv_iMKrg=inv(cv_MKrg);
0585         coefKRG=cv_iMKrg*[cv_y;zeros(dim_c,1)];
0586         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0587         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0588         <span class="comment">%extraction coefficients beta et gamma</span>
0589         beta=coefKRG((end-dim_c+1):end);
0590         
0591         <span class="comment">%calcul de la variance du processus</span>
0592         sig2=1/size(cv_rcc,1)*((cv_y-cv_fct*beta)'/cv_rcc)*(cv_y-cv_fct*beta);
0593         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0594         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0595         <span class="keyword">if</span> norm_on
0596             sig2=sig2*std_eval^2;
0597         <span class="keyword">end</span>
0598         <span class="comment">%calcul de la variance de prediction</span>
0599         cv_varR(tir)=sig2*(1-PP*(cv_iMKrg*PP'));
0600         <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>(~aff_warning);
0601     <span class="keyword">end</span>
0602     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0603     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0604     <span class="comment">%% Calcul des erreurs</span>
0605     [cv.final]=<a href="../../../GRENAT/routines/crit/calc_err_loo.html" class="code" title="function [ret]=calc_err_loo(Zref,Zap,variance,GZref,GZap,nb_val,nb_var,LOO_norm)">calc_err_loo</a>(zeros(size(esr)),-esr,cv_varR,[],[],nb_val,nb_var,LOO_norm);
0606     cv.then.scvr_min=cv.final.scvr_min;
0607     cv.then.scvr_max=cv.final.scvr_max;
0608     cv.then.scvr_mean=cv.final.scvr_mean;
0609     <span class="comment">%affichage qques infos</span>
0610     <span class="keyword">if</span> mod_debug||mod_final
0611         fprintf(<span class="string">'\n'</span>)
0612         fprintf(<span class="string">'=== CV-LOO SCVR\n'</span>);
0613         fprintf(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.final.scvr_min);
0614         fprintf(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.final.scvr_max);
0615         fprintf(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.final.scvr_mean);
0616     <span class="keyword">end</span>
0617     toc
0618 <span class="keyword">end</span>
0619 
0620 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0621 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0622 <span class="comment">%%Trace du graph QQ</span>
0623 <span class="keyword">if</span> meta.cv_aff&amp;&amp;mod_final
0624     <span class="comment">%normalisation</span>
0625     cv_zn=<a href="../../../GRENAT/routines/divers/norm_denorm.html" class="code" title="function [out,infos]=norm_denorm(in,type,infos)">norm_denorm</a>(cv_z,<span class="string">'norm'</span>,infos);
0626     opt.newfig=false;
0627     figure
0628     subplot(3,2,1);
0629     opt.title=<span class="string">'Original data (CV R)'</span>;
0630     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data_block.in.eval,cv_zR,opt)
0631     subplot(3,2,2);
0632     opt.title=<span class="string">'Standardized data (CV R)'</span>;
0633     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data_block.in.evaln,cv_zRn,opt)
0634     subplot(3,2,3);
0635     opt.title=<span class="string">'Original data (CV F)'</span>;
0636     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data_block.in.eval,cv_z,opt)
0637     subplot(3,2,4);
0638     opt.title=<span class="string">'Standardized data (CV F)'</span>;
0639     <a href="../../../GRENAT/routines/aff/qq_plot.html" class="code" title="function qq_plot(Zref,Zap,opt)">qq_plot</a>(data_block.in.evaln,cv_zn,opt)
0640     subplot(3,2,5);
0641     opt.title=<span class="string">'SCVR'</span>;
0642     opt.xlabel=<span class="string">'Predicted'</span> ;
0643     opt.ylabel=<span class="string">'SCVR'</span>;
0644     <a href="../../../GRENAT/routines/aff/scvr_plot.html" class="code" title="function scvr_plot(Zap,scvr,opt)">scvr_plot</a>(cv_zRn,cv.final.scvr,opt)
0645 <span class="keyword">end</span>
0646 <a href="#_sub1" class="code" title="subfunction ret_etat=mod_warning(etat_demande,old_etat)">mod_warning</a>([],state_warning);
0647 <span class="keyword">end</span>
0648 <span class="comment">%</span>
0649 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0650 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0651 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0652 <span class="comment">%fonction assurant l'arret de l'affichage des warning et le retour a letat initial</span>
0653 <a name="_sub1" href="#_subfunctions" class="code">function ret_etat=mod_warning(etat_demande,old_etat)</a>
0654 <span class="keyword">if</span> nargin==1
0655     <span class="keyword">if</span> ~etat_demande
0656         warning off all
0657     <span class="keyword">end</span>
0658 <span class="keyword">else</span>
0659     <span class="keyword">if</span> isempty(old_etat)
0660         ret_etat=warning;
0661     <span class="keyword">else</span>
0662         warning(old_etat)
0663     <span class="keyword">end</span>
0664 <span class="keyword">end</span>
0665 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 07-Feb-2014 20:13:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>