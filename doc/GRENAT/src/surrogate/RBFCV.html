<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of RBFCV</title>
  <meta name="keywords" content="RBFCV">
  <meta name="description" content="% Function for computing various Cross-Validation criteria for RBF/GRBF">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html GRENAT --><!-- # src --><!-- menu.html surrogate -->
<h1>RBFCV
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>% Function for computing various Cross-Validation criteria for RBF/GRBF</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [cv]=RBFCV(dataBloc,data,metaData,type) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Function for computing various Cross-Validation criteria for RBF/GRBF
L. LAURENT -- 14/12/2011 -- luc.laurent@lecnam.net
new version: 31/05/2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../GRENAT/src/crit/LOOCalcError.html" class="code" title="function [ret]=LOOCalcError(Zref,Zap,variance,GZref,GZap,ns,np,LOO_norm)">LOOCalcError</a>	% Function for calculating error of LOO (Cross-Validation)</li><li><a href="../../../GRENAT/src/disp/QQplot.html" class="code" title="function QQplot(Zref,Zap,opt)">QQplot</a>	% Plot QQ plot (for cross validation)</li><li><a href="../../../GRENAT/src/disp/SCVRplot.html" class="code" title="function SCVRplot(Zap,scvr,opt)">SCVRplot</a>	% Plot SCVR (for cross validation)</li><li><a href="RBFEval.html" class="code" title="function [Z,GZ,variance]=RBFEval(U,metaData,specifSampling)">RBFEval</a>	% function for evaluating the RBF surrogate model at many points</li><li><a href="../../../GRENAT/src/various/CheckInputData.html" class="code" title="function [ret]=CheckInputData(sampling,resp,grad)">CheckInputData</a>	% check input data for finding missing information</li><li><a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>	% function for printing information on the command window (based on fprintf)</li><li><a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>	MultiDOE - Toolbox for sampling a bounded space</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="RBFbloc.html" class="code" title="function [critMin,ret]=RBFBloc(dataIn,metaData,paraValIn,type)">RBFbloc</a>	% Building of the RBF/GRBF matrix and computation of the CV criteria</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function retStatus=modWarning(requireStatus,oldStatus)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% Function for computing various Cross-Validation criteria for RBF/GRBF</span>
0002 <span class="comment">%L. LAURENT -- 14/12/2011 -- luc.laurent@lecnam.net</span>
0003 <span class="comment">%new version: 31/05/2012</span>
0004 
0005 <span class="comment">%     GRENAT - GRadient ENhanced Approximation Toolbox</span>
0006 <span class="comment">%     A toolbox for generating and exploiting gradient-enhanced surrogate models</span>
0007 <span class="comment">%     Copyright (C) 2016  Luc LAURENT &lt;luc.laurent@lecnam.net&gt;</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%     This program is free software: you can redistribute it and/or modify</span>
0010 <span class="comment">%     it under the terms of the GNU General Public License as published by</span>
0011 <span class="comment">%     the Free Software Foundation, either version 3 of the License, or</span>
0012 <span class="comment">%     (at your option) any later version.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%     This program is distributed in the hope that it will be useful,</span>
0015 <span class="comment">%     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
0016 <span class="comment">%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
0017 <span class="comment">%     GNU General Public License for more details.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%     You should have received a copy of the GNU General Public License</span>
0020 <span class="comment">%     along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
0021 
0022 <a name="_sub0" href="#_subfunctions" class="code">function [cv]=RBFCV(dataBloc,data,metaData,type)</a>
0023 
0024 <span class="comment">%%DEBUG: procedure for missing data has to be coded</span>
0025 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0026 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0027 <span class="comment">%%%%%%%%%% OPTIONS</span>
0028 <span class="comment">%choice of the norma for LOO error</span>
0029 <span class="comment">%MSE: L2-norm</span>
0030 normLOO=<span class="string">'L2'</span>;
0031 <span class="comment">%debug</span>
0032 debugP=false;
0033 
0034 <span class="comment">% display warning or not</span>
0035 dispWarning=false;
0036 
0037 <span class="comment">%parallel</span>
0038 numWorkers=0;
0039 <span class="keyword">if</span> ~isempty(whos(<span class="string">'parallel'</span>,<span class="string">'global'</span>))
0040     <span class="keyword">global</span> parallel
0041     numWorkers=parallel.num;
0042 <span class="keyword">end</span>
0043 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0044 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0045 <span class="comment">%various situations</span>
0046 modDebug=debugP;modStudy=metaData.cv.full;modFinal=false;
0047 
0048 <span class="keyword">if</span> nargin==4
0049     <span class="keyword">switch</span> type
0050         <span class="keyword">case</span> <span class="string">'debug'</span> <span class="comment">%debug mode (display criteria)</span>
0051             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ CV RBF/GRBF in DEBUG mode\n'</span>);
0052             modDebug=true;
0053         <span class="keyword">case</span> <span class="string">'study'</span>  <span class="comment">%study mode (use both methods for calculating criteria)</span>
0054             modStudy=true;
0055         <span class="keyword">case</span> <span class="string">'estim'</span>  <span class="comment">%estimation mode</span>
0056             modStudy=false;
0057         <span class="keyword">case</span> <span class="string">'final'</span>  <span class="comment">%final mode (compute variances)</span>
0058             modFinal=true;
0059     <span class="keyword">end</span>
0060 <span class="keyword">else</span>
0061     modFinal=true;
0062 <span class="keyword">end</span>
0063 <span class="keyword">if</span> modFinal;countTime=<a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>;<span class="keyword">end</span>
0064 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0065 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0066 <span class="comment">%load variables</span>
0067 np=data.used.np;
0068 ns=data.used.ns;
0069 availGrad=data.used.availGrad;
0070 
0071 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0072 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0073 <span class="comment">%%% Rippa's method (Rippa 1999/Fasshauer 2007/Bompard 2011)</span>
0074 <span class="comment">% remove responses and then gradients (one by one)</span>
0075 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0076 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0077 <span class="comment">%vecteurs of the removed sample responses</span>
0078 esI=dataBloc.build.w./diag(dataBloc.build.iKK);
0079 esR=esI(1:ns);
0080 <span class="keyword">if</span> availGrad;esG=esI(ns+1:end);<span class="keyword">end</span>
0081 
0082 <span class="comment">%computation of the LOO criteria (various norms)</span>
0083 <span class="keyword">switch</span> normLOO
0084     <span class="keyword">case</span> <span class="string">'L1'</span>
0085         cv.then.press=esI'*esI;
0086         cv.then.eloot=1/numel(esI)*sum(abs(esI));
0087         cv.press=cv.then.press;
0088         cv.eloot=cv.then.eloot;
0089         <span class="keyword">if</span> availGrad
0090             cv.then.eloor=1/ns*sum(abs(esR));
0091             cv.then.eloog=1/(ns*np)*sum(abs(esG));
0092             cv.eloor=cv.then.eloor;
0093             cv.eloog=cv.then.eloog;
0094         <span class="keyword">end</span>
0095     <span class="keyword">case</span> <span class="string">'L2'</span> <span class="comment">%MSE</span>
0096         cv.then.press=esI'*esI;
0097         cv.then.eloot=1/numel(esI)*(cv.then.press);
0098         cv.press=cv.then.press;
0099         cv.eloot=cv.then.eloot;
0100         <span class="keyword">if</span> availGrad
0101             cv.then.press=esR'*esR;
0102             cv.then.eloor=1/ns*(cv.then.press);
0103             cv.then.eloog=1/(ns*np)*(esG'*esG);
0104             cv.press=cv.then.press;
0105             cv.eloor=cv.then.eloor;
0106             cv.eloog=cv.then.eloog;
0107         <span class="keyword">end</span>
0108     <span class="keyword">case</span> <span class="string">'Linf'</span>
0109         cv.then.press=esI'*esI;
0110         cv.then.eloot=1/numel(esI)*max(esI(:));
0111         cv.press=cv.then.press;
0112         cv.eloot=cv.then.eloot;
0113         <span class="keyword">if</span> availGrad
0114             cv.then.press=esR'*esR;
0115             cv.then.eloor=1/ns*max(esR(:));
0116             cv.then.eloog=1/(ns*np)*max(esG(:));
0117             cv.press=cv.then.press;
0118             cv.eloor=cv.then.eloor;
0119             cv.eloog=cv.then.eloog;
0120         <span class="keyword">end</span>
0121 <span class="keyword">end</span>
0122 <span class="comment">%mean of bias</span>
0123 cv.bm=1/ns*sum(esR);
0124 <span class="comment">%display information</span>
0125 <span class="keyword">if</span> modDebug||modFinal
0126     <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'\n=== CV-LOO using Rippa''s methods (1999, extension by Bompard 2011)\n'</span>);
0127     <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Used norm for calculate CV-LOO: %s\n'</span>,normLOO);
0128     <span class="keyword">if</span> availGrad
0129         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on responses %4.2e\n'</span>,cv.then.eloor);
0130         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on gradients %4.2e\n'</span>,cv.then.eloog);
0131     <span class="keyword">end</span>
0132     <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Total error %4.2e\n'</span>,cv.then.eloot);
0133     <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0134 <span class="keyword">end</span>
0135 
0136 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0137 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0138 <span class="comment">%%% Classical CV method (successively removing of responses and gradients))</span>
0139 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0140 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0141 <span class="keyword">if</span> modDebug    
0142     countTimeA=<a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>;
0143     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0144     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0145     <span class="comment">%store response at removed point</span>
0146     cvZ=zeros(ns,1);
0147     cvVar=zeros(ns,1);
0148     cvGZ=zeros(ns,np);
0149     yy=data.build.y;
0150     KK=dataBloc.build.KK;
0151     fctKern=dataBloc.build.fct;
0152     para=dataBloc.build.para;
0153     sampling=data.used.sampling;
0154     grad=data.used.grad;
0155     resp=data.used.resp;
0156     <span class="comment">%along the sample points</span>
0157     parfor (itS=1:ns,numWorkers)
0158         <span class="comment">%remove responses</span>
0159         <span class="comment">%Load data</span>
0160         dataCV=data;
0161         
0162         <span class="comment">%remove data</span>
0163         cvY=yy;
0164         cvKK=KK;
0165         cvY(itS,:)=[];
0166         cvKK(:,itS)=[];
0167         cvKK(itS,:)=[];
0168         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0169         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0170         <span class="comment">%compute coefficients</span>
0171         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(dispWarning)
0172         cvW=cvKK\cvY;
0173         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(~dispWarning)
0174         cvSampling=sampling;
0175         <span class="comment">%remove of the associated response</span>
0176         dataCV.miss.grad.on=false;
0177         dataCV.miss.resp.on=true;
0178         dataCV.miss.resp.ixMiss=itS;
0179         
0180         <span class="comment">%remove data</span>
0181         dataCV.build.fct=fctKern;
0182         dataCV.build.para=para;
0183         dataCV.build.w=cvW;
0184         dataCV.build.KK=cvKK;
0185         dataCV.used.ns=ns;
0186         dataCV.used.sampling=cvSampling;
0187         dataCV.infill.on=false;
0188         <span class="comment">%evaluate response and variances on removed sample points</span>
0189         [Z,~,variance]=<a href="RBFEval.html" class="code" title="function [Z,GZ,variance]=RBFEval(U,metaData,specifSampling)">RBFEval</a>(sampling(itS,:),dataCV);
0190         cvZ(itS)=Z;
0191         cvVar(itS)=variance;
0192         
0193         <span class="comment">%remove gradients</span>
0194         <span class="keyword">if</span> availGrad
0195             <span class="keyword">for</span> posGr=1:np
0196                 <span class="comment">%load data</span>
0197                 dataCV=data;                
0198                 <span class="comment">%remove data</span>
0199                 cvY=yy;
0200                 cvKK=KK;
0201                 pos=ns+(itS-1)*np+posGr;
0202                 cvY(pos,:)=[];
0203                 cvKK(:,pos)=[];
0204                 cvKK(pos,:)=[];
0205                 
0206                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0207                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0208                 <span class="comment">%ccompute coefficients</span>
0209                 <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(dispWarning)
0210                 cvW=cvKK\cvY;
0211                 <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(~dispWarning)
0212                 cvSampling=sampling;
0213                 <span class="comment">%remove associated gradient</span>
0214                 dataCV.miss.grad.on=true;
0215                 dataCV.miss.resp.on=false;
0216                 dataCV.miss.grad.ixtMissLine=pos-ns;
0217                 
0218                 <span class="comment">%remove</span>
0219                 dataCV.build.fct=fctKern;
0220                 dataCV.build.para=para;
0221                 dataCV.build.w=cvW;
0222                 dataCV.build.KK=cvKK;
0223                 dataCV.in.ns=ns;
0224                 dataCV.in.sampling=cvSampling;
0225                 dataCV.infill.on=false;
0226                 <span class="comment">%evaluate gradients on removed sample points</span>
0227                 [~,GZ,~]=<a href="RBFEval.html" class="code" title="function [Z,GZ,variance]=RBFEval(U,metaData,specifSampling)">RBFEval</a>(sampling(itS,:),dataCV);
0228                 cvGZ(itS,posGr)=GZ(posGr);
0229             <span class="keyword">end</span>
0230         <span class="keyword">end</span>
0231     <span class="keyword">end</span>
0232     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0233     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0234     <span class="comment">%% compute errors</span>
0235     [cv.then]=<a href="../../../GRENAT/src/crit/LOOCalcError.html" class="code" title="function [ret]=LOOCalcError(Zref,Zap,variance,GZref,GZap,ns,np,LOO_norm)">LOOCalcError</a>(resp,cvZ,cvVar,grad,cvGZ,ns,np,normLOO);
0236     <span class="comment">%display information</span>
0237     <span class="keyword">if</span> modDebug||modFinal
0238         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'\n=== CV-LOO with remove responses THEN the gradients (debug)\n'</span>);
0239         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Used norm for calculate CV-LOO: %s\n'</span>,normLOO);
0240         <span class="keyword">if</span> availGrad
0241             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on responses %4.2e\n'</span>,cv.then.eloor);
0242             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on gradients %4.2e\n'</span>,cv.then.eloog);
0243         <span class="keyword">end</span>
0244         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Total error %4.2e\n'</span>,cv.then.eloot);
0245         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Mean bias %4.2e\n'</span>,cv.then.bm);
0246         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0247         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Custom error %4.2e\n'</span>,cv.then.errp);
0248         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0249         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0250         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0251         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0252     <span class="keyword">end</span>
0253     countTimeA.stop;
0254 <span class="keyword">end</span>
0255 
0256 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0257 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0258 <span class="comment">%%% Classical CV method (remove simultaneously response and gradient</span>
0259 <span class="comment">%%% at each sample point)</span>
0260 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0261 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0262 <span class="keyword">if</span> (modStudy||modFinal)&amp;&amp;(modDebug||metaData.cv.disp)
0263     
0264     countTimeB=<a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>;
0265     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0266     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0267     <span class="comment">%store response of the surrogate model at remove sample point</span>
0268     cvZ=zeros(ns,1);
0269     cvVar=zeros(ns,1);
0270     cvGZ=zeros(ns,np);
0271     yy=data.build.y;
0272     KK=dataBloc.build.KK;    
0273     fctKern=dataBloc.build.kern;
0274     para=dataBloc.build.para;
0275     sampling=data.used.sampling;
0276     grad=data.used.grad;
0277     resp=data.used.resp;
0278     <span class="comment">%along the sample points</span>
0279     parfor (itS=1:ns,numWorkers)
0280         <span class="comment">%load data</span>
0281         dataCV=data;
0282         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0283         
0284         <span class="keyword">if</span> availGrad
0285             pos=[itS ns+(itS-1)*np+(1:np)];
0286         <span class="keyword">else</span>
0287             pos=itS;
0288         <span class="keyword">end</span>
0289         
0290         <span class="comment">%remove data</span>
0291         cvY=yy;
0292         cvKK=KK;
0293         cvY(pos,:)=[];
0294         cvKK(:,pos)=[];
0295         cvKK(pos,:)=[];
0296         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0297         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0298         <span class="comment">%compute coefficients</span>
0299         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(dispWarning)
0300         cvW=cvKK\cvY;
0301         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(~dispWarning)
0302         cvSampling=sampling;
0303         cvSampling(itS,:)=[];
0304         cvResp=resp;
0305         <span class="keyword">if</span> metaData.miss.resp.on||metaData.miss.grad.on
0306             cvResp(itS)=[];
0307             <span class="keyword">if</span> availGrad
0308                 cvGrad=grad;
0309                 cvGrad(itS,:)=[];
0310             <span class="keyword">else</span>
0311                 cvGrad=[];
0312             <span class="keyword">end</span>
0313             retMiss=<a href="../../../GRENAT/src/various/CheckInputData.html" class="code" title="function [ret]=CheckInputData(sampling,resp,grad)">CheckInputData</a>(cvSampling,cvResp,cvGrad);
0314             dataCV.miss=retMiss;
0315         <span class="keyword">else</span>
0316             dataCV.miss.resp.on=false;
0317             dataCV.miss.grad.on=false;
0318         <span class="keyword">end</span>
0319         
0320         dataCV.build.kern=fctKern;
0321         dataCV.build.para=para;
0322         dataCV.build.w=cvW;
0323         dataCV.build.KK=cvKK;
0324         dataCV.used.ns=ns-1; <span class="comment">%remove one sample point</span>
0325         dataCV.used.sampling=cvSampling;
0326         dataCV.infill.on=false;
0327         <span class="comment">%evaluate response, gradient and variance at the remove sample point</span>
0328         [Z,GZ,variance]=<a href="RBFEval.html" class="code" title="function [Z,GZ,variance]=RBFEval(U,metaData,specifSampling)">RBFEval</a>(sampling(itS,:),dataCV);
0329         cvZ(itS)=Z;
0330         cvGZ(itS,:)=GZ;
0331         cvVar(itS)=variance;
0332     <span class="keyword">end</span>
0333     
0334     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0335     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0336     <span class="comment">%% Compute errors</span>
0337     [cv.and]=<a href="../../../GRENAT/src/crit/LOOCalcError.html" class="code" title="function [ret]=LOOCalcError(Zref,Zap,variance,GZref,GZap,ns,np,LOO_norm)">LOOCalcError</a>(resp,cvZ,cvVar,grad,cvGZ,ns,np,normLOO);
0338     <span class="comment">%display informations</span>
0339     <span class="keyword">if</span> modDebug||modFinal
0340         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'\n=== CV-LOO with remove responses AND the gradients\n'</span>);
0341         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Used norm for calculate CV-LOO: %s\n'</span>,normLOO);
0342         <span class="keyword">if</span> availGrad
0343             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on responses %4.2e\n'</span>,cv.and.eloor);
0344             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on gradients %4.2e\n'</span>,cv.and.eloog);
0345         <span class="keyword">end</span>
0346         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Total error %4.2e\n'</span>,cv.and.eloot);
0347         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Mean bias %4.2e\n'</span>,cv.and.bm);
0348         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.and.press);
0349         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Custom error %4.2e\n'</span>,cv.and.errp);
0350         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.and.scvr_min);
0351         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.and.scvr_max);
0352         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.and.scvr_mean);
0353         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.and.adequ);
0354     <span class="keyword">end</span>
0355     countTimeB.stop;
0356 <span class="keyword">end</span>
0357 
0358 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0359 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0360 <span class="comment">%%Compute variance of prediction at sample points + check calculation on responses and gradients (for CV)</span>
0361 <span class="comment">%%%CAUTION: not functioning for missing data</span>
0362 <span class="keyword">if</span> (modStudy||modFinal)&amp;&amp;(metaData.cv.disp||modDebug)
0363     <span class="comment">%</span>
0364     countTimeC=<a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>;
0365     <span class="comment">%</span>
0366     cvVarR=zeros(ns,1);
0367     cvZR=zeros(ns,1);
0368     cvGZ=zeros(ns,np);
0369     KK=dataBloc.build.KK;
0370     yy=data.build.y;
0371     grad=data.used.grad;
0372     resp=data.used.resp;
0373     <span class="keyword">for</span> itS=1:ns
0374         <span class="comment">%remove only responses</span>
0375         pos=itS;
0376         <span class="comment">%extract vector and computation of the variance</span>
0377         PP=KK(itS,:);
0378         retKK=KK;
0379         retY=yy;
0380         retKK(pos,:)=[];
0381         retKK(:,pos)=[];
0382         retY(pos)=[];
0383         PP(pos)=[];
0384         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(dispWarning)
0385         cvVarR(itS)=1-PP*(retKK\PP');
0386         <span class="comment">%compute response</span>
0387         cvZR(itS)=PP*(retKK\retY);
0388         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(~dispWarning)
0389         <span class="comment">%remove gradients</span>
0390         <span class="keyword">if</span> availGrad
0391             <span class="keyword">for</span> posGr=1:np
0392                 <span class="comment">%load data</span>
0393                 pos=ns+(itS-1)*np+posGr;
0394                 <span class="comment">%extract vecteur</span>
0395                 dPP=KK(pos,:);
0396                 <span class="comment">%remove data</span>
0397                 retY=yy;
0398                 retKK=KK;
0399                 retY(pos,:)=[];
0400                 retKK(:,pos)=[];
0401                 retKK(pos,:)=[];
0402                 dPP(pos)=[];
0403                 <span class="comment">%compute gradients</span>
0404                 GZ=dPP*(retKK\retY);
0405                 cvGZ(itS,posGr)=GZ;
0406             <span class="keyword">end</span>
0407         <span class="keyword">end</span>
0408     <span class="keyword">end</span>
0409     
0410     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0411     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0412     <span class="comment">%% Compute errors</span>
0413     [cv.then]=<a href="../../../GRENAT/src/crit/LOOCalcError.html" class="code" title="function [ret]=LOOCalcError(Zref,Zap,variance,GZref,GZap,ns,np,LOO_norm)">LOOCalcError</a>(resp,cvZR,cvVarR,grad,cvGZ,ns,np,normLOO);
0414     <span class="comment">%display information</span>
0415     <span class="keyword">if</span> modDebug||modFinal
0416         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'\n=== CV-LOO with remove responses THEN the gradients\n'</span>);
0417         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Used norm for calculate CV-LOO: %s\n'</span>,normLOO);
0418         <span class="keyword">if</span> availGrad
0419             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on responses %4.2e\n'</span>,cv.then.eloor);
0420             <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Error on gradients %4.2e\n'</span>,cv.then.eloog);
0421         <span class="keyword">end</span>
0422         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Total error %4.2e\n'</span>,cv.then.eloot);
0423         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Mean bias %4.2e\n'</span>,cv.then.bm);
0424         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ PRESS %4.2e\n'</span>,cv.then.press);
0425         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Custom error %4.2e\n'</span>,cv.then.errp);
0426         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.then.scvr_min);
0427         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.then.scvr_max);
0428         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.then.scvr_mean);
0429         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ Adequation %4.2e\n'</span>,cv.then.adequ);
0430     <span class="keyword">end</span>
0431     countTimeC.stop;
0432 <span class="keyword">end</span>
0433 
0434 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0435 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0436 <span class="comment">%%Compute variance of prediction at the sample points (for CV)</span>
0437 <span class="comment">%%%CAUTION: not functioning for missing data</span>
0438 <span class="keyword">if</span> modFinal
0439     <span class="comment">%</span>
0440     countTimeD=<a href="../../../GRENAT/src/various/mesuTime.html" class="code" title="">mesuTime</a>;
0441     <span class="comment">%</span>
0442     cvVarR=zeros(ns,1);
0443     KK=dataBloc.build.KK;
0444     parfor (itS=1:ns,numWorkers)
0445         <span class="comment">%remove only responses</span>
0446         pos=itS;
0447         <span class="comment">%extract vector and compute variance</span>
0448         PP=KK(itS,:);
0449         retKK=KK;
0450         retKK(pos,:)=[];
0451         retKK(:,pos)=[];
0452         PP(pos)=[];
0453         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(dispWarning)
0454         cvVarR(itS)=1-PP*(retKK\PP');
0455         <a href="#_sub1" class="code" title="subfunction retStatus=modWarning(requireStatus,oldStatus)">modWarning</a>(~dispWarning)
0456     <span class="keyword">end</span>
0457     
0458     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0459     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0460     <span class="comment">%% Compute errors</span>
0461     [cv.final]=<a href="../../../GRENAT/src/crit/LOOCalcError.html" class="code" title="function [ret]=LOOCalcError(Zref,Zap,variance,GZref,GZap,ns,np,LOO_norm)">LOOCalcError</a>(zeros(size(esR)),-esR,cvVarR,[],[],ns,np,normLOO);
0462     cv.then.scvr_min=cv.final.scvr_min;
0463     cv.then.scvr_max=cv.final.scvr_max;
0464     cv.then.scvr_mean=cv.final.scvr_mean;
0465     <span class="comment">%display information</span>
0466     <span class="keyword">if</span> modDebug||modFinal
0467         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'\n=== CV-LOO SCVR\n'</span>);
0468         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Min) %4.2e\n'</span>,cv.final.scvr_min);
0469         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Max) %4.2e\n'</span>,cv.final.scvr_max);
0470         <a href="../../../GRENAT/src/various/Gfprintf.html" class="code" title="function nbT = Gfprintf(varargin)">Gfprintf</a>(<span class="string">'+++ SCVR (Mean) %4.2e\n'</span>,cv.final.scvr_mean);
0471     <span class="keyword">end</span>
0472     countTimeD.stop;
0473 <span class="keyword">end</span>
0474 
0475 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0476 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0477 <span class="comment">%%Show QQ-plot</span>
0478 <span class="keyword">if</span> metaData.cv.disp&amp;&amp;modFinal
0479     opt.newfig=false;
0480     figure
0481     subplot(1,3,1);
0482     opt.title=<span class="string">'Normalized data (CV R)'</span>;
0483     <a href="../../../GRENAT/src/disp/QQplot.html" class="code" title="function QQplot(Zref,Zap,opt)">QQplot</a>(data.used.resp,cvZR,opt)
0484     subplot(1,3,2);
0485     opt.title=<span class="string">'Normalized data (CV F)'</span>;
0486     <a href="../../../GRENAT/src/disp/QQplot.html" class="code" title="function QQplot(Zref,Zap,opt)">QQplot</a>(data.used.resp,cvZ,opt)
0487     subplot(1,3,3);
0488     opt.title=<span class="string">'SCVR (Normalized)'</span>;
0489     opt.xlabel=<span class="string">'Predicted'</span> ;
0490     opt.ylabel=<span class="string">'SCVR'</span>;
0491     <a href="../../../GRENAT/src/disp/SCVRplot.html" class="code" title="function SCVRplot(Zap,scvr,opt)">SCVRplot</a>(cvZR,cv.final.scvr,opt)
0492     
0493 <span class="comment">%     % original data</span>
0494 <span class="comment">%     subplot(2,3,4);</span>
0495 <span class="comment">%     opt.title='Original data (CV R)';</span>
0496 <span class="comment">%     QQplot(data.used.resp,cvZR,opt)</span>
0497 <span class="comment">%     subplot(2,3,5);</span>
0498 <span class="comment">%     opt.title='Original data (CV F)';</span>
0499 <span class="comment">%     QQplot(data.used.resp,cvZ,opt)</span>
0500 <span class="comment">%     subplot(2,3,6);</span>
0501 <span class="comment">%     opt.title='SCVR (Normalized)';</span>
0502 <span class="comment">%     opt.xlabel='Predicted' ;</span>
0503 <span class="comment">%     opt.ylabel='SCVR';</span>
0504 <span class="comment">%     SCVRplot(cvZR,cv.final.scvr,opt)</span>
0505 <span class="keyword">end</span>
0506 <span class="comment">%</span>
0507 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0508 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0509 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0510 <span class="keyword">if</span> modFinal;countTime.stop;<span class="keyword">end</span>
0511 <span class="keyword">end</span>
0512 
0513 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0514 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0515 <span class="comment">% function for stopping the display of the warning and restoring initial</span>
0516 <span class="comment">% state</span>
0517 <a name="_sub1" href="#_subfunctions" class="code">function retStatus=modWarning(requireStatus,oldStatus)</a>
0518 <span class="keyword">if</span> nargin==1
0519     <span class="keyword">if</span> ~requireStatus
0520         warning off all
0521     <span class="keyword">end</span>
0522 <span class="keyword">else</span>
0523     <span class="keyword">if</span> isempty(oldStatus)
0524         retStatus=warning;
0525     <span class="keyword">else</span>
0526         warning(oldStatus)
0527     <span class="keyword">end</span>
0528 <span class="keyword">end</span>
0529 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 12-Sep-2016 18:26:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>